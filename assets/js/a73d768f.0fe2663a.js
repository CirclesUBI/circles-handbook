(self.webpackChunkcircles_handbook=self.webpackChunkcircles_handbook||[]).push([[842],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return c},kt:function(){return h}});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var d=a.createContext({}),l=function(e){var n=a.useContext(d),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},c=function(e){var n=l(e.components);return a.createElement(d.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},p=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,s=e.originalType,d=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=l(t),h=i,f=p["".concat(d,".").concat(h)]||p[h]||u[h]||s;return t?a.createElement(f,r(r({ref:n},c),{},{components:t})):a.createElement(f,r({ref:n},c))}));function h(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var s=t.length,r=new Array(s);r[0]=p;var o={};for(var d in n)hasOwnProperty.call(n,d)&&(o[d]=n[d]);o.originalType=e,o.mdxType="string"==typeof e?e:i,r[1]=o;for(var l=2;l<s;l++)r[l]=t[l];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}p.displayName="MDXCreateElement"},920:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return r},metadata:function(){return o},toc:function(){return d},default:function(){return c}});var a=t(4786),i=t(6843),s=(t(7294),t(3905)),r={id:"circles-by-sbt-ethereum",title:"Circles by hand with sbt-ethereum",slug:"/developers/tutorials/circles-by-hand-with-sbt-ethereum"},o={unversionedId:"developers/tutorials/circles-by-sbt-ethereum",id:"developers/tutorials/circles-by-sbt-ethereum",isDocsHomePage:!1,title:"Circles by hand with sbt-ethereum",description:"Author: Steve Randy Waldman 2021-03-23",source:"@site/docs/developers/tutorials/circles-by-hand-with-sbt-ethereum.md",sourceDirName:"developers/tutorials",slug:"/developers/tutorials/circles-by-hand-with-sbt-ethereum",permalink:"/docs/developers/tutorials/circles-by-hand-with-sbt-ethereum",editUrl:"https://github.com/CirclesUBI/circles-handbook/edit/main/docs/developers/tutorials/circles-by-hand-with-sbt-ethereum.md",version:"current",frontMatter:{id:"circles-by-sbt-ethereum",title:"Circles by hand with sbt-ethereum",slug:"/developers/tutorials/circles-by-hand-with-sbt-ethereum"},sidebar:"developers",previous:{title:"The limitation of transitive transactions in practice",permalink:"/docs/developers/transitive-transactions/transfer-limitations-in-practice"},next:{title:"Exploring transfer steps and estimating the gas cost",permalink:"/docs/developers/tutorials/estimate-gas-cost"}},d=[{value:"The web-app is weird",id:"the-web-app-is-weird",children:[]},{value:"Circles contracts",id:"circles-contracts",children:[]},{value:"Circles by hand",id:"circles-by-hand",children:[{value:"Create a new project",id:"create-a-new-project",children:[]},{value:"Check out build.sbt",id:"check-out-buildsbt",children:[]},{value:"Startup sbt-ethereum",id:"startup-sbt-ethereum",children:[]}]},{value:"Create a wallet for our Circles identity",id:"create-a-wallet-for-our-circles-identity",children:[]},{value:"Prepare to work with the Circles hub",id:"prepare-to-work-with-the-circles-hub",children:[]},{value:"Fund our Circles identity",id:"fund-our-circles-identity",children:[]},{value:"Sign up for Circles as our new identity",id:"sign-up-for-circles-as-our-new-identity",children:[]},{value:"Working with our \u201cme-coin\u201d",id:"working-with-our-me-coin",children:[]},{value:"Trust trust trust",id:"trust-trust-trust",children:[]},{value:"Collecting our \u201cUBI\u201d",id:"collecting-our-ubi",children:[]},{value:"Using <code>transferThrough</code> to make a \u201chub transfer\u201d",id:"using-transferthrough-to-make-a-hub-transfer",children:[]},{value:"Conclusion",id:"conclusion",children:[]},{value:"Appendix: Circles hub source code",id:"appendix-circles-hub-source-code",children:[]}],l={toc:d};function c(e){var n=e.components,t=(0,i.Z)(e,["components"]);return(0,s.kt)("wrapper",(0,a.Z)({},l,t,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Author: Steve Randy Waldman 2021-03-23")),(0,s.kt)("p",null,"Here we\u2019ll go through the exercise of creating a ",(0,s.kt)("em",{parentName:"p"},"Circles")," identity by hand with sbt-ethereum."),(0,s.kt)("h2",{id:"the-web-app-is-weird"},"The web-app is weird"),(0,s.kt)("p",null,"Our command-line adventure will be ",(0,s.kt)("strong",{parentName:"p"},"very, very")," different from the experience the ",(0,s.kt)("em",{parentName:"p"},"Circles")," web application encourages of users. (See ",(0,s.kt)("a",{parentName:"p",href:"https://joincircles.net/"},"https://joincircles.net/")," and ",(0,s.kt)("a",{parentName:"p",href:"https://circles.garden/."},"https://circles.garden/."),") The UI works to hide or abstract nearly all the details of working with an ",(0,s.kt)("em",{parentName:"p"},"Ethereum"),"-ish blockchain application. Users via the web UI don\u2019t use a browser-based crypto wallet like ",(0,s.kt)("em",{parentName:"p"},"Metamask"),". Instead, they sign up as for a Web 2.0 application with an e-mail address and username. A private key is then generated for the user, presented as a ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki"},"BIP-39-style")," list of words."),(0,s.kt)("p",null,"An address \u2014 the user\u2019s identity \u2014 is also defined for each user, but that address is not the same address as that for which the private key was generated. Instead it is as address to which a ",(0,s.kt)("a",{parentName:"p",href:"https://gnosis-safe.io/"},"Gnosis Safe")," contract (or really a proxy thereof) can eventually be deployed via the EVM ",(0,s.kt)("a",{parentName:"p",href:"https://eips.ethereum.org/EIPS/eip-1014"},(0,s.kt)("inlineCode",{parentName:"a"},"CREATE2"))," opcode. eventually. Eventually."),(0,s.kt)("p",null,"But, because in the web application ",(0,s.kt)("em",{parentName:"p"},"Circles")," (or ",(0,s.kt)("a",{parentName:"p",href:"https://gnosis.io/"},"Gnosis"),", or someone) is handling the gas costs for user transactions, it had to be built with a degree of caution. If any signup provoked smart contract creations or transactions, miscreants could force arbitrary expenses on the payer just by spoofing new users. To prevent this, the ",(0,s.kt)("em",{parentName:"p"},"Circles")," requires new users to become trusted by at least three existing users before their identity (the ",(0,s.kt)("a",{parentName:"p",href:"https://gnosis-safe.io/"},"Gnosis Safe")," proxy) is actually materialized on the blockchain, along with their own ERC-20 token (the ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/14/Circles-with-sbt-ethereum.html"},"\u201cme-coin\u201d"),") in which they\u2019ll receive their UBI."),(0,s.kt)("h2",{id:"circles-contracts"},"Circles contracts"),(0,s.kt)("p",null,"Behind the ",(0,s.kt)("em",{parentName:"p"},"Circles")," application sits three contracts on the ",(0,s.kt)("a",{parentName:"p",href:"https://blockscout.com/poa/xdai"},"xDAI blockchain"),". Pretty much the only place I found the addresses of these contracts documented is in ",(0,s.kt)("a",{parentName:"p",href:"https://twitter.com/CirclesUBI/status/1317089774293962753"},"this tweet"),". The three contracts are\u2026"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"The Hub @ ",(0,s.kt)("a",{parentName:"li",href:"https://blockscout.com/xdai/mainnet/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/transactions"},(0,s.kt)("inlineCode",{parentName:"a"},"0x29b9a7fBb8995b2423a71cC17cf9810798F6C543")),": This is the core of the ",(0,s.kt)("em",{parentName:"li"},"Circles")," application, the smart contract that tracks identities and trust relationships, and that launches token contracts for each ",(0,s.kt)("em",{parentName:"li"},"Circles")," identity. We will interact with this contract. (We\u2019ve reproduced its full source code as an ",(0,s.kt)("a",{parentName:"li",href:"https://www.sbt-ethereum.io/blog/2021/03/23/Circles-with-sbt-ethereum-II-Circles-by-hand-redux.html#Appendix-Circles-hub-source-code"},"appendix")," to this post.)"),(0,s.kt)("li",{parentName:"ol"},"The Proxy Factory @ ",(0,s.kt)("a",{parentName:"li",href:"https://blockscout.com/xdai/mainnet/address/0x8b4404DE0CaECE4b966a9959f134f0eFDa636156/transactions"},(0,s.kt)("inlineCode",{parentName:"a"},"0x8b4404DE0CaECE4b966a9959f134f0eFDa636156")),": This contract is invoked by the middleware / web-UI to create proxy ",(0,s.kt)("a",{parentName:"li",href:"https://gnosis-safe.io/"},"Gnosis Safe")," contracts, representing user identities."),(0,s.kt)("li",{parentName:"ol"},"The Master Gnosis Safe @ ",(0,s.kt)("a",{parentName:"li",href:"https://blockscout.com/xdai/mainnet/address/0x2CB0ebc503dE87CFD8f0eCEED8197bF7850184ae/transactions"},(0,s.kt)("inlineCode",{parentName:"a"},"0x2CB0ebc503dE87CFD8f0eCEED8197bF7850184ae")),": Identities are efficiently implemented as tiny proxies to a ",(0,s.kt)("a",{parentName:"li",href:"https://gnosis-safe.io/"},"Gnosis Safe")," implementation, and this is that implementation. Operations on the contracts that represent users happen via ",(0,s.kt)("inlineCode",{parentName:"li"},"DELEGATECALL")," to this master implementation.")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},(0,s.kt)("em",{parentName:"strong"},"Note:"))," ",(0,s.kt)("em",{parentName:"p"},"When I first examined ",(0,s.kt)("a",{parentName:"em",href:"https://blockscout.com/xdai/mainnet/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/transactions"},"the hub on the xDAI block explorer"),", I thought it must be misidentified. Transactions involving it seemed too few and infrequent. But that\u2019s not right. Since nearly all activity involving the hub is initiated by a user identity, which are nearly all ",(0,s.kt)("a",{parentName:"em",href:"https://gnosis-safe.io/"},"Gnosis Safe")," contracts, the calls to hub methods are treated as ",(0,s.kt)("a",{parentName:"em",href:"https://blockscout.com/poa/xdai/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/internal-transactions"},"internal transactions"),", of which there are plenty.")),(0,s.kt)("h2",{id:"circles-by-hand"},"Circles by hand"),(0,s.kt)("p",null,"If you want to play along, you\u2019ll need to have set up your sbt-ethereum environment to work on the xDAI blockchain. Please see previous posts ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/02/19/Getting-started-on-the-xDAI-chain-with-sbt-ethereum.html"},"to get started on xDAI"),", and ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/02/20/Converting-DAI-to-xDAI-with-sbt-ethereum.html"},"to give yourself some xDAI to fund transactions"),"."),(0,s.kt)("p",null,"Since you\u2019re too lazy to review those posts (I would be!), I\u2019ll work from an empty sbt-ethereum shoebox (by using the setting ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/settings/index.html#ethcfgshoeboxdirectory"},(0,s.kt)("inlineCode",{parentName:"a"},"ethcfgShoeboxDirectory"))," in my ",(0,s.kt)("inlineCode",{parentName:"p"},"build.sbt")," file, so my main shoebox is not used). ",(0,s.kt)("em",{parentName:"p"},"But if you are following along, and you want to make a Circles identity you will keep, don\u2019t do this!"),". Use your default shoebox directory, so that your identity is permanently available by default. You should be able to follow along with every step, except the part about having someone send you some xDAI so you can run transactions. You\u2019ll have to find a friend, try the ",(0,s.kt)("a",{parentName:"p",href:"https://www.xdaichain.com/for-users/get-xdai-tokens/xdai-faucet"},"semi-abandoned faucet"),", or ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/02/20/Converting-DAI-to-xDAI-with-sbt-ethereum.html"},"use the DAI-to-xDAI bridge yourself"),". (Feel free to ",(0,s.kt)("a",{parentName:"p",href:"mailto:swaldman@mchange.com"},"hit me up")," for the few cents you\u2019ll need.)"),(0,s.kt)("p",null,"Let\u2019s get started! I\u2019ll assume you have ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/appendix/prerequisites.html"},(0,s.kt)("em",{parentName:"a"},"sbt-ethereum\u2018s")," prerequisites"),", ",(0,s.kt)("em",{parentName:"p"},"sbt")," and a JVM, on your machine already."),(0,s.kt)("h3",{id:"create-a-new-project"},"Create a new project"),(0,s.kt)("p",null,"Through the terminal we can create a project as shown below. When prompted for a project name I choose ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-tutorial"),". Then change into the new project directory."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ sbt new swaldman/solidity-seed.g8\n[info] Loading settings for project global-plugins from dependency-graph.sbt,metals.sbt,gpg.sbt ...\n[info] Loading global plugins from /Users/swaldman/.sbt/1.0/plugins\n[warn] There may be incompatibilities among your library dependencies; run 'evicted' to see detailed eviction warnings.\n[info] Loading project definition from /Users/swaldman/project\n[warn] There may be incompatibilities among your library dependencies; run 'evicted' to see detailed eviction warnings.\n[info] Set current project to swaldman (in build file:/Users/swaldman/)\n[info] Set current project to swaldman (in build file:/Users/swaldman/)\n\nA minimal solidity project for sbt-ethereum \n\nname [my-solidity-project]: circles-tutorial\nversion [0.0.1-SNAPSHOT]: \nsbt_ethereum_version [0.5.3]: \nsbt_version [1.3.13]: \n\nTemplate applied in /Users/swaldman/./circles-tutorial\n\n$ cd circles-tutorial/\n")),(0,s.kt)("h3",{id:"check-out-buildsbt"},"Check out build.sbt"),(0,s.kt)("p",null,"It looks like this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'name := "circles-tutorial"\n\nversion := "0.0.1-SNAPSHOT"\n')),(0,s.kt)("p",null,"Because I ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/14/Circles-with-sbt-ethereum.html"},"already have a ",(0,s.kt)("em",{parentName:"a"},"Circles")," identity"),", I don\u2019t want to create a new one in my default ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/shoebox/index.html"},(0,s.kt)("em",{parentName:"a"},"sbt-ethereum")," shoebox"),". So I\u2019ll edit my ",(0,s.kt)("inlineCode",{parentName:"p"},"build.sbt")," to use an empty, throwaway shoebox. ",(0,s.kt)("strong",{parentName:"p"},"You probably don\u2019t want to do this! You should make your own identity to keep, in your default ",(0,s.kt)("em",{parentName:"strong"},"sbt-ethereum")," shoebox!")),(0,s.kt)("p",null,"Since we\u2019ll be working on the xDAI chain (chain ID 100), we\u2019ll also make that the default chain for this project. That\u2019s only a convenience. We can always switch to xDAI by typing ",(0,s.kt)("inlineCode",{parentName:"p"},"ethNodeChainIdOverride 100"),"."),(0,s.kt)("p",null,"Anyway, here\u2019s my edited ",(0,s.kt)("inlineCode",{parentName:"p"},"build.sbt"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'name := "circles-tutorial" \n\nversion := "0.0.1-SNAPSHOT"                    \n\nethcfgNodeChainId := 100 // you probably want this \n\nethcfgShoeboxDirectory := "throwaway-shoebox" // you probably DON\'T want this! keep your work\n')),(0,s.kt)("h3",{id:"startup-sbt-ethereum"},"Startup sbt-ethereum"),(0,s.kt)("p",null,"From inside the ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-tutorial")," directory\u2026"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ sbt\n[info] welcome to sbt 1.3.13 (Oracle Corporation Java 11.0.3)\n[info] loading settings for project global-plugins from dependency-graph.sbt,metals.sbt,gpg.sbt ...\n[info] loading global plugins from /Users/swaldman/.sbt/1.0/plugins\n[warn] There may be incompatibilities among your library dependencies; run 'evicted' to see detailed eviction warnings.\n[info] loading settings for project circles-tutorial-build-build from security.sbt ...\n[info] loading project definition from /Users/swaldman/circles-tutorial/project/project\n[warn] There may be incompatibilities among your library dependencies; run 'evicted' to see detailed eviction warnings.\n[info] loading settings for project circles-tutorial-build from security.sbt,plugins.sbt ...\n[info] loading project definition from /Users/swaldman/circles-tutorial/project\n[warn] There may be incompatibilities among your library dependencies; run 'evicted' to see detailed eviction warnings.\nMar 20, 2021 9:12:54 PM com.mchange.v2.log.MLog \nINFO: MLog clients using java 1.4+ standard logging with redirectable loggers.\n[info] loading settings for project circles-tutorial from build.sbt ...\n[info] set current project to circles-tutorial (in build file:/Users/swaldman/circles-tutorial/)\nThere are no wallets in the sbt-ethereum keystore. Would you like to generate one? [y/n] n\n[warn] No wallet created. To create one, try 'ethKeystoreWalletV3Create', 'ethKeystoreFromJsonImport', or 'ethKeystoreFromPrivateKeyImport'.\nThe current default solidity compiler ['0.7.6'] is not installed. Install? [y/n] n\n[info] Updating available solidity compiler set.\n[info] sbt-ethereum-0.5.3 successfully initialized (built Thu, 18 Mar 2021 19:46:19 -0400)\n[info]  + shoebox directory: '/Users/swaldman/circles-tutorial/throwaway-shoebox'\nsbt:circles-tutorial> \n")),(0,s.kt)("p",null,"Because I\u2019m using a fresh, empty shoebox, sbt-ethereum asked if I wanted to generate a wallet address or download a solidity compiler. We will want to generate a wallet address, but we\u2019ll do it explicitly, since readers may not be prompted to create one on startup. Let\u2019s do that!"),(0,s.kt)("h2",{id:"create-a-wallet-for-our-circles-identity"},"Create a wallet for our Circles identity"),(0,s.kt)("p",null,"We\u2019ll use the task ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/23/ethKeystoreWalletV3Create"},(0,s.kt)("inlineCode",{parentName:"a"},"ethKeystoreWalletV3Create")),". I\u2019m going to call this identity \u201ccircles-snoopy\u201d, because it ain\u2019t me babe! It\u2019s just a throwaway identity for this tutorial. If you are making an identity to keep, you might use your own name rather than \u201csnoopy\u201d."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethKeystoreWalletV3Create\n[info] Generated keypair for address '0xB157256Af409007d903B443349bf49A9D6a1f519'\n[info] Generating V3 wallet, algorithm=scrypt, n=262144, r=8, p=1, dklen=32\nEnter passphrase for new wallet: ************************\nPlease retype to confirm: ************************\n[info] Wallet generated into sbt-ethereum shoebox: 'throwaway-shoebox'. Please backup, via 'ethShoeboxBackup' or manually.\n[info] Consider validating the wallet using 'ethKeystoreWalletV3Validate 0xB157256Af409007d903B443349bf49A9D6a1f519'.\nWould you like to define an alias for address '0xB157256Af409007d903B443349bf49A9D6a1f519' (on chain with ID 100)? [y/n] y\nPlease enter an alias for address '0xB157256Af409007d903B443349bf49A9D6a1f519' (on chain with ID 100): circles-snoopy\n[info] Alias 'circles-snoopy' now points to address '0xB157256Af409007d903B443349bf49A9D6a1f519' (for chain with ID 100).\n[info] Refreshing caches.\n[success] Total time: 104 s (01:44), completed Mar 20, 2021, 9:23:27 PM\n")),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Note: Scroll right to see the part where we entered in the alias circles-snoopy.")),(0,s.kt)("p",null,"Cool."),(0,s.kt)("h2",{id:"prepare-to-work-with-the-circles-hub"},"Prepare to work with the Circles hub"),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Circles\u2018")," core contract is the hub, which is on the xDAI chain at address ",(0,s.kt)("inlineCode",{parentName:"p"},"0x29b9a7fBb8995b2423a71cC17cf9810798F6C543"),". Let\u2019s use ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/address/alias.html#ethaddressaliasset"},(0,s.kt)("inlineCode",{parentName:"a"},"ethAddressAliasSet"))," to give that an alias:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethAddressAliasSet circles-hub 0x29b9a7fBb8995b2423a71cC17cf9810798F6C543\n[info] Alias 'circles-hub' now points to address '0x29b9a7fBb8995b2423a71cC17cf9810798F6C543' (for chain with ID 100).\n[info] Refreshing caches.\n[success] Total time: 0 s, completed Mar 20, 2021, 9:30:46 PM\n")),(0,s.kt)("p",null,"Notice that address aliased are scoped to the Chain ID. Make sure that your output includes the ",(0,s.kt)("inlineCode",{parentName:"p"},"for chain with ID 100"),", the xDAI chain. If you are on the wrong chain, you can drop the alias with ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/address/alias.html#ethaddressaliasdrop"},(0,s.kt)("inlineCode",{parentName:"a"},"ethAddressAliasDrop")),", switch to the xDAI chain with ",(0,s.kt)("inlineCode",{parentName:"p"},"ethNodeChainIdOverride 100"),", and rerun the command."),(0,s.kt)("p",null,"Before we can interact with ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-hub")," we\u2019ll need to import its ABI. When we\u2019re working on the Ethereum main chain, we can often ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tutorials/using-a-smart-contract-i.html#automatically-acquiring-an-abi-from-optional-"},"automatically import ABIs from Etherscan"),". We can\u2019t do that for contracts on the xDAI blockchain. Instead, we browse the xDAI Blockscout to find the ",(0,s.kt)("a",{parentName:"p",href:"https://blockscout.com/poa/xdai/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/contracts"},"verified contract ABI"),", and let ",(0,s.kt)("em",{parentName:"p"},"sbt-ethereum")," scrape the from the page (a new sbt-ethereum 0.5.3 feature!):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethContractAbiImport circles-hub\n[error] stack trace is suppressed; run last Compile / xethInvokerContext for the full output\n[error] (Compile / xethInvokerContext) com.mchange.sc.v1.sbtethereum.package$InvokerContextNotAvailableException: Could not instantiate an Invoker context. Please ensure that you have a node URL defined for the current chain ID. Try 'eth'.\n[error] Total time: 0 s, completed Mar 20, 2021, 9:44:22 PM\n")),(0,s.kt)("p",null,"Oopsie! The important bit there was ",(0,s.kt)("inlineCode",{parentName:"p"},"Please ensure that you have a node URL defined for the current chain ID. Try 'eth'.")),(0,s.kt)("p",null,"Since I\u2019m working with a fresh environment (shoebox) that has never interacted with the xDAI chain, I need to define the URL to a node\u2019s JSON-RPC service! Let\u2019s do that:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethNodeUrlDefaultSet https://rpc.xdaichain.com/\n[info] Successfully set default node json-rpc URL for chain with ID 100 to https://rpc.xdaichain.com/.\n[success] Total time: 0 s, completed Mar 20, 2021, 9:48:14 PM\n")),(0,s.kt)("p",null,"Cool. Our error suggested we type ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/index.html"},(0,s.kt)("inlineCode",{parentName:"a"},"eth"))," to check out our environment. Let\u2019s do that."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> eth\n[info] The session is now active on chain with ID 100, with node URL 'https://rpc.xdaichain.com/'.\n[warn] There is no sender available for the current session.\n[warn] Consider using 'ethAddressSenderDefaultSet' or 'ethAddressSenderOverrideSet' to define one.\n[info] The current default gas price according to your node is 1 gwei. (THIS MAY CHANGE AT ANY TIME.)\n[success] Total time: 0 s, completed Mar 20, 2021, 9:51:26 PM\n")),(0,s.kt)("p",null,"We\u2019re advised to set a sender for our session. Let\u2019s do that to. In my case, working from a fresh environment, I\u2019ll just make ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy")," the default sender with ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/address/sender.html#ethaddresssenderdefaultset"},(0,s.kt)("inlineCode",{parentName:"a"},"ethAddressSenderDefaultSet")),". If you already have a default sender set-up for xDAI, and want to keep it, you can temporarily override it for this session with either ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/address/sender.html#ethaddresssenderoverrideset"},(0,s.kt)("inlineCode",{parentName:"a"},"ethAddressSenderOverrideSet"))," or [",(0,s.kt)("inlineCode",{parentName:"p"},"ethAddressSenderOverride"),")(",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/address/sender.html#ethaddresssenderoverride"},"https://www.sbt-ethereum.io/tasks/eth/address/sender.html#ethaddresssenderoverride"),"). (The two are synonyms.) Anyway, you do you. Here\u2019s me:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethAddressSenderDefaultSet circles-snoopy\n[info] Successfully set default sender address for chain with ID 100 to '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100).\n[info] You can use the synthetic alias 'default-sender' to refer to this address.\n[info] Refreshing caches.\n[success] Total time: 0 s, completed Mar 20, 2021, 9:55:47 PM\n")),(0,s.kt)("p",null,"Let\u2019s check out our environment again with ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/index.html"},(0,s.kt)("inlineCode",{parentName:"a"},"eth")),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> eth\n[info] The session is now active on chain with ID 100, with node URL 'https://rpc.xdaichain.com/'.\n[info] The current session sender is '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100).\n[info] The current default gas price according to your node is 2 gwei. (THIS MAY CHANGE AT ANY TIME.)\n[success] Total time: 0 s, completed Mar 20, 2021, 9:58:17 PM\n")),(0,s.kt)("p",null,"Okay. Anyway, let\u2019s try importing the contract ABI again. Remember, we can find the ABI embedded in the URL ",(0,s.kt)("a",{parentName:"p",href:"https://blockscout.com/poa/xdai/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/contracts"},"https://blockscout.com/poa/xdai/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/contracts")),(0,s.kt)("p",null,"Importing the ABI will be very little work, but will yield a ",(0,s.kt)("strong",{parentName:"p"},(0,s.kt)("em",{parentName:"strong"},"very"))," long output. You can expand below to view it!"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethContractAbiImport circles-hub\nTo import an ABI, you may provide the JSON ABI directly, or else a file path or URL from which the ABI can be downloaded.\nContract ABI or Source: https://blockscout.com/poa/xdai/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/contracts\n[info] Attempting to interactively import a contract ABI.\n[info] Checking to see if you have provided a JSON array or object directly.\n[info] The provided text does not appear to be a JSON ABI.\n[info] Checking if the provided source exists as a File.\n[info] No file found. Checking if the provided source is interpretable as a URL.\n[info] Interpreted user-provided source as a URL. Attempting to fetch contents.\nWe can attempt to SCRAPE a unique ABI from the text of the provided source.\nBe sure you trust 'https://blockscout.com/poa/xdai/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/contracts' to contain a reliable representation of the ABI.\nScrape for the ABI? [y/n] y\n[info] No ABI was discovered in the raw bytes downloaded from 'https://blockscout.com/poa/xdai/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/contracts'.ircles-tutorial / Compile / ethContractAbiImport 0s\n[info] Retrying, after unescaping as HTML.\n[info] We had to scrape, but we were able to recover a unique ABI from source 'https://blockscout.com/poa/xdai/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/contracts'!\nReady to import the following ABI:\n")),(0,s.kt)("details",null,(0,s.kt)("summary",null,(0,s.kt)("i",null,"Show ABI")),(0,s.kt)("div",null,(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'[ {\n  "type" : "constructor",\n  "stateMutability" : "nonpayable",\n  "inputs" : [ {\n    "type" : "uint256", / Compile / ethContractAbiImport 0s\n    "name" : "_inflation",\n    "internalType" : "uint256"\n  }, {\n    "type" : "uint256",\n    "name" : "_period",\n    "internalType" : "uint256"\n  }, {\n    "type" : "string",\n    "name" : "_symbol",\n    "internalType" : "string"\n  }, {\n    "type" : "string",\n    "name" : "_name",\n    "internalType" : "string"\n  }, {\n    "type" : "uint256",\n    "name" : "_signupBonus",\n    "internalType" : "uint256"\n  }, {\n    "type" : "uint256",\n    "name" : "_initialIssuance",\n    "internalType" : "uint256"\n  }, {\n    "type" : "uint256",\n    "name" : "_timeout",\n    "internalType" : "uint256"\n  } ]\n}, {\n  "type" : "event",\n  "name" : "HubTransfer",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "from",\n    "internalType" : "address",\n    "indexed" : true\n  }, {\n    "type" : "address",\n    "name" : "to",\n    "internalType" : "address",\n    "indexed" : true\n  }, {\n    "type" : "uint256",\n    "name" : "amount",\n    "internalType" : "uint256",\n    "indexed" : false\n  } ],\n  "anonymous" : false\n}, {\n  "type" : "event",\n  "name" : "OrganizationSignup",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "organization",\n    "internalType" : "address",\n    "indexed" : true\n  } ],\n  "anonymous" : false\n}, {\n  "type" : "event",\n  "name" : "Signup",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "user",\n    "internalType" : "address",\n    "indexed" : true\n  }, {\n    "type" : "address",\n    "name" : "token",\n    "internalType" : "address",\n    "indexed" : false\n  } ],\n  "anonymous" : false\n}, {\n  "type" : "event",\n  "name" : "Trust",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "canSendTo",\n    "internalType" : "address",\n    "indexed" : true\n  }, {\n    "type" : "address",\n    "name" : "user",\n    "internalType" : "address",\n    "indexed" : true\n  }, {\n    "type" : "uint256",\n    "name" : "limit",\n    "internalType" : "uint256",\n    "indexed" : false\n  } ],\n  "anonymous" : false\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "checkSendLimit",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "tokenOwner",\n    "internalType" : "address"\n  }, {\n    "type" : "address",\n    "name" : "src",\n    "internalType" : "address"\n  }, {\n    "type" : "address",\n    "name" : "dest",\n    "internalType" : "address"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "deployedAt",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "divisor",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "inflate",\n  "inputs" : [ {\n    "type" : "uint256",\n    "name" : "_initial",\n    "internalType" : "uint256"\n  }, {\n    "type" : "uint256",\n    "name" : "_periods",\n    "internalType" : "uint256"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "inflation",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "initialIssuance",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "issuance",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "issuanceByStep",\n  "inputs" : [ {\n    "type" : "uint256",\n    "name" : "_periods",\n    "internalType" : "uint256"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "limits",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "address"\n  }, {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "address"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "string",\n    "name" : "",\n    "internalType" : "string"\n  } ],\n  "name" : "name",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "nonpayable",\n  "outputs" : [ ],\n  "name" : "organizationSignup",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "bool",\n    "name" : "",\n    "internalType" : "bool"\n  } ],\n  "name" : "organizations",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "address"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "period",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "periods",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "pure",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "pow",\n  "inputs" : [ {\n    "type" : "uint256",\n    "name" : "base",\n    "internalType" : "uint256"\n  }, {\n    "type" : "uint256",\n    "name" : "exponent",\n    "internalType" : "uint256"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "address"\n  } ],\n  "name" : "seen",\n  "inputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "nonpayable",\n  "outputs" : [ ],\n  "name" : "signup",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "signupBonus",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "string",\n    "name" : "",\n    "internalType" : "string"\n  } ],\n  "name" : "symbol",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "uint256",\n    "name" : "",\n    "internalType" : "uint256"\n  } ],\n  "name" : "timeout",\n  "inputs" : [ ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "address"\n  } ],\n  "name" : "tokenToUser",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "address"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "nonpayable",\n  "outputs" : [ ],\n  "name" : "transferThrough",\n  "inputs" : [ {\n    "type" : "address[]",\n    "name" : "tokenOwners",\n    "internalType" : "address[]"\n  }, {\n    "type" : "address[]",\n    "name" : "srcs",\n    "internalType" : "address[]"\n  }, {\n    "type" : "address[]",\n    "name" : "dests",\n    "internalType" : "address[]"\n  }, {\n    "type" : "uint256[]",\n    "name" : "wads",\n    "internalType" : "uint256[]"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "nonpayable",\n  "outputs" : [ ],\n  "name" : "trust",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "user",\n    "internalType" : "address"\n  }, {\n    "type" : "uint256",\n    "name" : "limit",\n    "internalType" : "uint256"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "contract Token"\n  } ],\n  "name" : "userToToken",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "address"\n  } ]\n}, {\n  "type" : "function",\n  "stateMutability" : "view",\n  "outputs" : [ {\n    "type" : "bool",\n    "name" : "seen",\n    "internalType" : "bool"\n  }, {\n    "type" : "uint256",\n    "name" : "sent",\n    "internalType" : "uint256"\n  }, {\n    "type" : "uint256",\n    "name" : "received",\n    "internalType" : "uint256"\n  } ],\n  "name" : "validation",\n  "inputs" : [ {\n    "type" : "address",\n    "name" : "",\n    "internalType" : "address"\n  } ]\n} ]\n')))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"Do you wish to import this ABi? [y/n] y\n[info] A default ABI is now known for the contract at address 0x29b9a7fBb8995b2423a71cC17cf9810798F6C543\n[info] Refreshing caches.\n[success] Total time: 111 s (01:51), completed Mar 20, 2021, 10:05:27 PM\n")),(0,s.kt)("p",null,"Looks good. Let\u2019s see if we can read stuff from the contract."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionView circles-hub <tab>\ncheckSendLimit    deployedAt        divisor           inflate           inflation         initialIssuance   issuance          issuanceByStep    \nlimits            name              organizations     period            periods           pow               seen              signupBonus       \nsymbol            timeout           tokenToUser       userToToken       validation        \u200b                  \nsbt:circles-tutorial> ethTransactionView circles-hub period\n[info] The function 'period' yields 1 result.\n[info]  + Result 1 of type 'uint256' is 31556952\n[success] Total time: 0 s, completed Mar 20, 2021, 10:08:17 PM\n")),(0,s.kt)("p",null,"Yes we can!"),(0,s.kt)("h2",{id:"fund-our-circles-identity"},"Fund our Circles identity"),(0,s.kt)("p",null,"This is the part that will require a bit of help from outside this tutorial. Our new identity (",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy")," in my case) will want to call the ",(0,s.kt)("inlineCode",{parentName:"p"},"signup")," method on the ",(0,s.kt)("em",{parentName:"p"},"Circles")," hub. But we can\u2019t call methods that modify the blockchain unless we have \u201cether\u201d (xDAI on the xDAI chain) with which to pay for gas. First, let\u2019s checkout our identity\u2019s current balance:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethAddressBalance circles-snoopy\n0 ether (as of the latest incorporated block, address 0xB157256Af409007d903B443349bf49A9D6a1f519)\n(The USD value of this is unknown, no exchange value is currently available for chain with ID 100 from Coinbase.)\n[success] Total time: 0 s, completed Mar 20, 2021, 10:13:27 PM\n")),(0,s.kt)("p",null,"We\u2019re broke. So now we\u2019ll have to find a friend, try the ",(0,s.kt)("a",{parentName:"p",href:"https://www.xdaichain.com/for-users/get-xdai-tokens/xdai-faucet"},"semi-abandoned faucet"),", or ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/02/20/Converting-DAI-to-xDAI-with-sbt-ethereum.html"},"use the DAI-to-xDAI bridge to get some funds"),". Feel free to ",(0,s.kt)("a",{parentName:"p",href:"mailto:swaldman@mchange.com"},"hit me up")," for the few cents you\u2019ll need. I\u2019ll send myself a few cents worth of xDAI from elsewhere, then recheck my balance."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethAddressBalance circles-snoopy\n0.1 ether (as of the latest incorporated block, address 0xB157256Af409007d903B443349bf49A9D6a1f519)\n(The USD value of this is unknown, no exchange value is currently available for chain with ID 100 from Coinbase.)\n[success] Total time: 0 s, completed Mar 20, 2021, 10:18:15 PM\n")),(0,s.kt)("p",null,"We have ca$h!"),(0,s.kt)("h2",{id:"sign-up-for-circles-as-our-new-identity"},"Sign up for Circles as our new identity"),(0,s.kt)("p",null,"Now that ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy")," is funded we can sign up. We\u2019ve already made this address our default sender, but you may not have, so let\u2019s make sure that account our session sender using ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/address/sender.html#ethaddresssenderoverride"},(0,s.kt)("inlineCode",{parentName:"a"},"ethAddressSenderOverride")),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethAddressSenderOverride circles-snoopy\n[info] Sender override set to '0xB157256Af409007d903B443349bf49A9D6a1f519' (on chain with ID 100, aliases ['circles-snoopy','default-sender'])).\n[success] Total time: 0 s, completed Mar 20, 2021, 10:23:21 PM\n")),(0,s.kt)("p",null,"Okay. Now let\u2019s sign up with the hub."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionInvoke circles-hub signup\n\n==> T R A N S A C T I O N   S I G N A T U R E   R E Q U E S T\n==>\n==> The transaction would be a message with...\n==>   To:    0x29b9a7fBb8995b2423a71cC17cf9810798F6C543 (with aliases ['circles-hub'] on chain with ID 100)\n==>   From:  0xB157256Af409007d903B443349bf49A9D6a1f519 (with aliases ['circles-snoopy','default-sender'] on chain with ID 100)\n==>   Data:  0xb7bc0f73 / Compile / ethTransactionInvoke 0s\n==>   Value: 0 ether\n==>\n==> According to the ABI currently associated with the 'to' address, this message would amount to the following method call...\n==>   Function called: signup()\n==>\n==> The nonce of the transaction would be 0.\n==>\n==> $$$ The transaction you have requested could use up to 1497631 units of gas.\n==> $$$ You would pay 20 gwei for each unit of gas, for a maximum cost of 0.02995262 ether.\n==> $$$ (No USD value could be determined for ETH on chain with ID 100 from Coinbase).\n\nWould you like to sign this transaction? [y/n] y\n\n[info] Unlocking address '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100).\nEnter passphrase or hex private key for address '0xB157256Af409007d903B443349bf49A9D6a1f519': ************************\n[info] Called function 'signup', with args '', sending 0 wei to address '0x29b9a7fBb8995b2423a71cC17cf9810798F6C543' in transaction with hash '0x0ed96eff6caeeb3c92896bfd77165b2ad5349b91e5b6126c1baf7baf3a208451'.\n[info] Waiting for the transaction to be mined (will wait up to 5 minutes).\n[error] stack trace is suppressed; run last Compile / ethTransactionInvoke for the full output\n[error] (Compile / ethTransactionInvoke) com.mchange.sc.v1.consuela.ethereum.jsonrpc.package$ClientException: Block information is incomplete while ancient block sync is still in progress, before it's finished we can't determine the existence of requested item. -- errorCode=-32000; methodName=eth_getTransactionReceipt; params=List(\"0x0ed96eff6caeeb3c92896bfd77165b2ad5349b91e5b6126c1baf7baf3a208451\")\n[error] Total time: 26 s, completed Mar 20, 2021, 10:25:03 PM\n")),(0,s.kt)("p",null,"Uh-oh. Some weird shit happened there. We successfully submitted the transaction, but while we were waiting for a transaction receipt to prove it had been mined, ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/openethereum/parity-ethereum/issues/10777"},"some Parity/openethereum-client thing went wrong"),". We have the transaction hash, ",(0,s.kt)("inlineCode",{parentName:"p"},"0x0ed96eff6caeeb3c92896bfd77165b2ad5349b91e5b6126c1baf7baf3a208451"),". (Scroll all the way to the right to see it.) We can manually check for the transaction receipt to see how our signup attempt turned out using ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/openethereum/parity-ethereum/issues/10777"},(0,s.kt)("inlineCode",{parentName:"a"},"ethTransactionLookup")),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionLookup 0x0ed96eff6caeeb3c92896bfd77165b2ad5349b91e5b6126c1baf7baf3a208451\n[info] Looking up transaction '0x0ed96eff6caeeb3c92896bfd77165b2ad5349b91e5b6126c1baf7baf3a208451' (will wait up to 5 minutes).\n[info] Transaction Receipt:\n[info]        Transaction Hash:    0x0ed96eff6caeeb3c92896bfd77165b2ad5349b91e5b6126c1baf7baf3a208451\n[info]        Transaction Index:   3\n[info]        Transaction Status:  SUCCEEDED\n[info]        Block Hash:          0xf8d6258f8a889981818eff16d8a88acd0fa03973c7e396f08b35edf1be9e62e2\n[info]        Block Number:        15117319\n[info]        From:                0xB157256Af409007d903B443349bf49A9D6a1f519\n[info]        To:                  0x29b9a7fBb8995b2423a71cC17cf9810798F6C543\n[info]        Cumulative Gas Used: 2901510\n[info]        Gas Used:            1227346\n[info]        Contract Address:    None\n[info]        Logs:                0 => EthLogEntry [source=0xf910549FdbA1083B7E515029601e8Bc748774C64] (\n[info]                                    topics=[\n[info]                                      0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef,\n[info]                                      0x0000000000000000000000000000000000000000000000000000000000000000,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519\n[info]                                    ],\n[info]                                    data=000000000000000000000000000000000000000000000002b5e3af16b1880000\n[info]                                  ),\n[info]                             1 => EthLogEntry [source=0x29b9a7fBb8995b2423a71cC17cf9810798F6C543] (\n[info]                                    topics=[\n[info]                                      0xe60c754dd8ab0b1b5fccba257d6ebcd7d09e360ab7dd7a6e58198ca1f57cdcec,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519\n[info]                                    ],\n[info]                                    data=0000000000000000000000000000000000000000000000000000000000000064\n[info]                                  ),\n[info]                             2 => EthLogEntry [source=0x29b9a7fBb8995b2423a71cC17cf9810798F6C543] (\n[info]                                    topics=[\n[info]                                      0x358ba8f768af134eb5af120e9a61dc1ef29b29f597f047b555fc3675064a0342,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519\n[info]                                    ],\n[info]                                    data=000000000000000000000000f910549fdba1083b7e515029601e8bc748774c64\n[info]                                  )\n[info]        Events:              0 => Anonymous Event [source=0xf910549FdbA1083B7E515029601e8Bc748774C64],\n[info]                             1 => Trust [source=0x29b9a7fBb8995b2423a71cC17cf9810798F6C543] (\n[info]                                    canSendTo (of type address): 0xB157256Af409007d903B443349bf49A9D6a1f519,\n[info]                                    user (of type address): 0xB157256Af409007d903B443349bf49A9D6a1f519,\n[info]                                    limit (of type uint256): 100\n[info]                                  ),\n[info]                             2 => Signup [source=0x29b9a7fBb8995b2423a71cC17cf9810798F6C543] (\n[info]                                    user (of type address): 0xB157256Af409007d903B443349bf49A9D6a1f519,\n[info]                                    token (of type address): 0xf910549FdbA1083B7E515029601e8Bc748774C64\n[info]                                  )\n[success] Total time: 3 s, completed Mar 20, 2021, 10:32:51 PM\n")),(0,s.kt)("p",null,"Our signup did succeed! Notice a \u201ctrust\u201d event also occurred. If we look at the ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/23/Circles-with-sbt-ethereum-II-Circles-by-hand-redux.html#Appendix-Circles-hub-source-code"},"hub source code"),", we\u2019ll see that as part of the signup process, we trust ourselves 100%!"),(0,s.kt)("h2",{id:"working-with-our-me-coin"},"Working with our \u201cme-coin\u201d"),(0,s.kt)("p",null,"Looking at the transaction above, we can see in the ",(0,s.kt)("inlineCode",{parentName:"p"},"Signup")," event the address of our new ERC-20 token contract, ",(0,s.kt)("inlineCode",{parentName:"p"},"0xf910549FdbA1083B7E515029601e8Bc748774C64"),". We can also find the address of our token by accessing the ",(0,s.kt)("inlineCode",{parentName:"p"},"userToToken")," mapping:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionView circles-hub userToToken circles-snoopy\n[info] The function 'userToToken' yields 1 result.\n[info]  + Result 1 of type 'address' is 0xf910549FdbA1083B7E515029601e8Bc748774C64\n[success] Total time: 0 s, completed Mar 20, 2021, 10:38:58 PM\n")),(0,s.kt)("p",null,"They agree! Let\u2019s give our new token an alias. Usually I alias ERC-20 tokens by their self-reported symbols. For ",(0,s.kt)("em",{parentName:"p"},"Circles")," tokens, every user\u2019s token advertises the symbol CRC. So we\u2019ll call our new token ",(0,s.kt)("inlineCode",{parentName:"p"},"CRC-snoopy"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethAddressAliasSet CRC-snoopy 0xf910549FdbA1083B7E515029601e8Bc748774C64\n[info] Alias 'CRC-snoopy' now points to address '0xf910549FdbA1083B7E515029601e8Bc748774C64' (for chain with ID 100).\n[info] Refreshing caches.\n[success] Total time: 0 s, completed Mar 20, 2021, 10:42:25 PM\n")),(0,s.kt)("p",null,"That should be an ERC-20 token, so let\u2019s use sbt-ethereum\u2018s built-in ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/erc20.html#erc20summary"},(0,s.kt)("inlineCode",{parentName:"a"},"erc20Summary"))," task to check it out."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> erc20Summary CRC-snoopy\n[info] ERC20 Summary, token contract at '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100):\n[info]   Self-Reported Name:   Circles\n[info]   Self-Reported Symbol: CRC\n[info]   Decimals:             18\n[info]   Total Supply:         50 tokens (50000000000000000000 atoms)\n[success] Total time: 0 s, completed Mar 20, 2021, 10:43:24 PM\n")),(0,s.kt)("p",null,"Looks good!"),(0,s.kt)("p",null,"Let\u2019s check our own balance:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> erc20Balance CRC-snoopy circles-snoopy\n[info] For ERC20 Token Contract '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100), with 18 decimals...\n[info]   For Address '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100))...\n[info]     Balance: 50 tokens (which corresponds to 50000000000000000000 atoms)\n")),(0,s.kt)("p",null,"We own all 50 of the current total supply. We\u2019re rich!"),(0,s.kt)("p",null,"This should be a perfectly normal ERC-20 token. It will have some special functionality \u2014 most importantly an ",(0,s.kt)("inlineCode",{parentName:"p"},"update")," method through which the token owner, ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-token"),", can receive its \u201cUBI\u201d, and the capacity to call ",(0,s.kt)("inlineCode",{parentName:"p"},"transferThrough")," on the hub, which ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/14/Circles-with-sbt-ethereum.html"},"restricts transfers according to trust relationships")," and emits a special ",(0,s.kt)("inlineCode",{parentName:"p"},"HubTransfer")," event. But we can use our new token just like a plain old ERC-20 too. Let\u2019s give that a try. We should be able to send our token to an arbitrary Ethereum address. (Ideally one that we control, if we want our token back!):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> erc20Transfer CRC-snoopy 0x72a8a15ECa1f824ADE35cdEB2148223402f23448 1\n[warn] For the ERC20 token with contract address '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100)...\n[warn]   you would transfer 1 tokens, which (with 18 decimals) translates to 1000000000000000000 atoms.\n[warn] The transfer would be \n[warn]   From: '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100)\n[warn]   To:   '0x72a8a15ECa1f824ADE35cdEB2148223402f23448' (on chain with ID 100)\n[warn] You are calling the 'transfer' function on the contract at '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100).\n[warn] THIS FUNCTION COULD DO ANYTHING. \n[warn] Make sure that you trust that the token contract does only what you intend, and carefully verify the transaction cost before approving the ultimate transaction.\nContinue? [y/n] y\n\n==> T R A N S A C T I O N   S I G N A T U R E   R E Q U E S T\n==>\n==> The transaction would be a message with...\n==>   To:    0xf910549FdbA1083B7E515029601e8Bc748774C64 (with aliases ['CRC-snoopy'] on chain with ID 100)\n==>   From:  0xB157256Af409007d903B443349bf49A9D6a1f519 (with aliases ['circles-snoopy','default-sender'] on chain with ID 100)\n==>   Data:  0xa9059cbb00000000000000000000000072a8a15eca1f824ade35cdeb2148223402f234480000000000000000000000000000000000000000000000000de0b6b3a7640000\n==>   Value: 0 ether\n==>\n==> !!! Any ABI is associated with the destination address is currently unknown, so we cannot decode the message data as a method call !!!\n==>\n==> The nonce of the transaction would be 1.\n==>\n==> $$$ The transaction you have requested could use up to 63421 units of gas.\n==> $$$ You would pay 20 gwei for each unit of gas, for a maximum cost of 0.00126842 ether.\n==> $$$ (No USD value could be determined for ETH on chain with ID 100 from Coinbase).\n\nWould you like to sign this transaction? [y/n] y\n\n[info] Unlocking address '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100).\nEnter passphrase or hex private key for address '0xB157256Af409007d903B443349bf49A9D6a1f519': ************************\n[info] ERC20 Transfer, Token Contract '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100):\n[info]   --\x3e Sent 1 tokens (1000000000000000000 atoms)\n[info]   --\x3e   from '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100)\n[info]   --\x3e   to '0x72a8a15ECa1f824ADE35cdEB2148223402f23448' (on chain with ID 100)\n[info] Waiting for the transaction to be mined (will wait up to 5 minutes).\n[info] Transaction Receipt:\n[info]        Transaction Hash:    0xa44798d3f08ce87c84044784bc6cf8b18e4bac291f92bda0e85b8833808507ea\n[info]        Transaction Index:   2\n[info]        Transaction Status:  SUCCEEDED\n[info]        Block Hash:          0x7aaaee8ed5c70583e7ec081c6388c699b8546e3013470817ff66770e3289baa9\n[info]        Block Number:        15117617\n[info]        From:                0xB157256Af409007d903B443349bf49A9D6a1f519\n[info]        To:                  0xf910549FdbA1083B7E515029601e8Bc748774C64\n[info]        Cumulative Gas Used: 1283692\n[info]        Gas Used:            51350\n[info]        Contract Address:    None\n[info]        Logs:                0 => EthLogEntry [source=0xf910549FdbA1083B7E515029601e8Bc748774C64] (\n[info]                                    topics=[\n[info]                                      0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519,\n[info]                                      0x00000000000000000000000072a8a15eca1f824ade35cdeb2148223402f23448\n[info]                                    ],\n[info]                                    data=0000000000000000000000000000000000000000000000000de0b6b3a7640000\n[info]                                  )\n[info]        Events:              0 => Transfer [source=0xf910549FdbA1083B7E515029601e8Bc748774C64] (\n[info]                                    from (of type address): 0xB157256Af409007d903B443349bf49A9D6a1f519,\n[info]                                    to (of type address): 0x72a8a15ECa1f824ADE35cdEB2148223402f23448,\n[info]                                    tokens (of type uint256): 1000000000000000000\n[info]                                  )\n[success] Total time: 43 s, completed Mar 20, 2021, 10:49:59 PM\n")),(0,s.kt)("p",null,"It seems to have worked! We\u2019ve sent one token from ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy")," (which owned all 50 of the initial supply) to ",(0,s.kt)("inlineCode",{parentName:"p"},"0x72a8a15ECa1f824ADE35cdEB2148223402f23448")," (an address I control). We expect ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy")," to now have a balance of only 49 tokens, and ",(0,s.kt)("inlineCode",{parentName:"p"},"0x72a8a15ECa1f824ADE35cdEB2148223402f23448")," to have a balance of one token. First let\u2019s check circles-snoopy:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> erc20Balance CRC-snoopy circles-snoopy\n[info] For ERC20 Token Contract '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100), with 18 decimals...\n[info]   For Address '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100))...\n[info]     Balance: 49 tokens (which corresponds to 49000000000000000000 atoms)\n[success] Total time: 0 s, completed Mar 20, 2021, 10:55:17 PM\n")),(0,s.kt)("p",null,"49 tokens as expected! Now let\u2019s check the balance of ",(0,s.kt)("inlineCode",{parentName:"p"},"0x72a8a15ECa1f824ADE35cdEB2148223402f23448"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> erc20Balance CRC-snoopy 0x72a8a15ECa1f824ADE35cdEB2148223402f23448\n[info] For ERC20 Token Contract '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100), with 18 decimals...\n[info]   For Address '0x72a8a15ECa1f824ADE35cdEB2148223402f23448' (on chain with ID 100))...\n[info]     Balance: 1 tokens (which corresponds to 1000000000000000000 atoms)\n[success] Total time: 0 s, completed Mar 20, 2021, 10:56:18 PM\n")),(0,s.kt)("p",null,"One token, also as expected. Yay!"),(0,s.kt)("h2",{id:"trust-trust-trust"},"Trust trust trust"),(0,s.kt)("p",null,"My \u201creal\u201d circles identity is ",(0,s.kt)("inlineCode",{parentName:"p"},"0x647E68F4BCBC843F39c80bb02da96dD13308f657"),". Let\u2019s define an alias for that, ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-steve"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethAddressAliasSet circles-steve 0x647E68F4BCBC843F39c80bb02da96dD13308f657\n[info] Alias 'circles-steve' now points to address '0x647E68F4BCBC843F39c80bb02da96dD13308f657' (for chain with ID 100).\n[info] Refreshing caches.\n[success] Total time: 0 s, completed Mar 20, 2021, 10:59:45 PM\n")),(0,s.kt)("p",null,"The hub has a ",(0,s.kt)("inlineCode",{parentName:"p"},"trust")," method that accepts an address and a limit (from 0 to 100, interpreted as degree of trust in the form of a percentage. Let\u2019s trust that bastard steve 50%:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionInvoke circles-hub trust circles-steve 50\n\n==> T R A N S A C T I O N   S I G N A T U R E   R E Q U E S T\n==>\n==> The transaction would be a message with...\n==>   To:    0x29b9a7fBb8995b2423a71cC17cf9810798F6C543 (with aliases ['circles-hub'] on chain with ID 100)\n==>   From:  0xB157256Af409007d903B443349bf49A9D6a1f519 (with aliases ['circles-snoopy','default-sender'] on chain with ID 100)\n==>   Data:  0x9951d62f000000000000000000000000647e68f4bcbc843f39c80bb02da96dd13308f6570000000000000000000000000000000000000000000000000000000000000032| => circles-tutorial / Compile / ethTransactionInvoke 0s\n==>   Value: 0 ether\n==>\n==> According to the ABI currently associated with the 'to' address, this message would amount to the following method call...\n==>   Function called: trust(address,uint256)\n==>     Arg 1 [name=user, type=address]: 0x647E68F4BCBC843F39c80bb02da96dD13308f657\n==>     Arg 2 [name=limit, type=uint256]: 50\n==>\n==> The nonce of the transaction would be 2.\n==>\n==> $$$ The transaction you have requested could use up to 57835 units of gas.\n==> $$$ You would pay 1 gwei for each unit of gas, for a maximum cost of 0.000057835 ether.\n==> $$$ (No USD value could be determined for ETH on chain with ID 100 from Coinbase).\n\nWould you like to sign this transaction? [y/n] y\n\n[info] Unlocking address '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100).\nEnter passphrase or hex private key for address '0xB157256Af409007d903B443349bf49A9D6a1f519': ************************\n[info] Called function 'trust', with args '647e68f4bcbc843f39c80bb02da96dd13308f657, 50', sending 0 wei to address '0x29b9a7fBb8995b2423a71cC17cf9810798F6C543' in transaction with hash '0x4b76f6fdfde76c2dbb26b790f9184e2315cb60f234b637337dd14ac219426f64'.\n[info] Waiting for the transaction to be mined (will wait up to 5 minutes).\n[error] stack trace is suppressed; run last Compile / ethTransactionInvoke for the full output\n[error] (Compile / ethTransactionInvoke) com.mchange.sc.v1.consuela.ethereum.jsonrpc.package$ClientException: Block information is incomplete while ancient block sync is still in progress, before it's finished we can't determine the existence of requested item. -- errorCode=-32000; methodName=eth_getTransactionReceipt; params=List(\"0x4b76f6fdfde76c2dbb26b790f9184e2315cb60f234b637337dd14ac219426f64\")\n[error] Total time: 18 s, completed Mar 20, 2021, 11:03:16 PM\n")),(0,s.kt)("p",null,"Grrr. That ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/openethereum/parity-ethereum/issues/10777"},"weird Parity/openethereum-client thing")," occurred again, while we were waiting for a transaction receipt for transaction ",(0,s.kt)("inlineCode",{parentName:"p"},"0x4b76f6fdfde76c2dbb26b790f9184e2315cb60f234b637337dd14ac219426f64"),". (Scroll all the way to the right to see this hash.) We again have to verify the mining of that transaction by hand, using ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/transaction/index.html#ethtransactionlookup-transaction-hash-"},(0,s.kt)("inlineCode",{parentName:"a"},"ethTransactionLookup")),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionLookup 0x4b76f6fdfde76c2dbb26b790f9184e2315cb60f234b637337dd14ac219426f64\n[info] Looking up transaction '0x4b76f6fdfde76c2dbb26b790f9184e2315cb60f234b637337dd14ac219426f64' (will wait up to 5 minutes).\n[info] Transaction Receipt:\n[info]        Transaction Hash:    0x4b76f6fdfde76c2dbb26b790f9184e2315cb60f234b637337dd14ac219426f64\n[info]        Transaction Index:   9\n[info]        Transaction Status:  SUCCEEDED\n[info]        Block Hash:          0xa9fabeca7e7bd3b7f701cb7624faa76b6cac16bd70936143a0cbc0ca25f1e668\n[info]        Block Number:        15117777\n[info]        From:                0xB157256Af409007d903B443349bf49A9D6a1f519\n[info]        To:                  0x29b9a7fBb8995b2423a71cC17cf9810798F6C543\n[info]        Cumulative Gas Used: 5864451\n[info]        Gas Used:            46695\n[info]        Contract Address:    None\n[info]        Logs:                0 => EthLogEntry [source=0x29b9a7fBb8995b2423a71cC17cf9810798F6C543] (\n[info]                                    topics=[\n[info]                                      0xe60c754dd8ab0b1b5fccba257d6ebcd7d09e360ab7dd7a6e58198ca1f57cdcec,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519,\n[info]                                      0x000000000000000000000000647e68f4bcbc843f39c80bb02da96dd13308f657\n[info]                                    ],\n[info]                                    data=0000000000000000000000000000000000000000000000000000000000000032\n[info]                                  )\n[info]        Events:              0 => Trust [source=0x29b9a7fBb8995b2423a71cC17cf9810798F6C543] (\n[info]                                    canSendTo (of type address): 0xB157256Af409007d903B443349bf49A9D6a1f519,\n[info]                                    user (of type address): 0x647E68F4BCBC843F39c80bb02da96dD13308f657,\n[info]                                    limit (of type uint256): 50\n[info]                                  )\n")),(0,s.kt)("p",null,"The transaction did succeed. We can verify that by checking the trust limit of ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy")," for ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-steve")," using ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/transaction/index.html#ethtransactionview"},(0,s.kt)("inlineCode",{parentName:"a"},"ethTransactionView")),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionView circles-hub limits circles-snoopy circles-steve\n[info] The function 'limits' yields 1 result.\n[info]  + Result 1 of type 'uint256' is 50\n[success] Total time: 2 s, completed Mar 20, 2021, 11:09:17 PM\n")),(0,s.kt)("p",null,"As expected, it\u2019s 50%. Which seems generous, considering."),(0,s.kt)("h2",{id:"collecting-our-ubi"},"Collecting our \u201cUBI\u201d"),(0,s.kt)("p",null,"We let some time pass, and start a session in our ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-tutorial")," project. Let\u2019s check ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy"),"\u2018s current balance of ",(0,s.kt)("inlineCode",{parentName:"p"},"CRC-snoopy"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> erc20Balance CRC-snoopy circles-snoopy\n[info] For ERC20 Token Contract '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100), with 18 decimals...\n[info]   For Address '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100))...\n[info]     Balance: 49 tokens (which corresponds to 49000000000000000000 atoms)\n[success] Total time: 1 s, completed Mar 23, 2021, 12:02:20 AM\n")),(0,s.kt)("p",null,"It\u2019s the same as before, 49 tokens, we haven\u2019t received any UBI yet. But wait! We\u2019re not supposed to until we call an ",(0,s.kt)("inlineCode",{parentName:"p"},"update")," method. (See the ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/23/Circles-with-sbt-ethereum-II-Circles-by-hand-redux.html#Appendix-Circles-hub-source-code"},"source code in the appendix"),", which includes the token contract.)"),(0,s.kt)("p",null,"Since ",(0,s.kt)("inlineCode",{parentName:"p"},"update()")," is not a standard ERC-20 method, we\u2019ll need to import the ABI for ",(0,s.kt)("em",{parentName:"p"},"Circles"),"-specific tokens. We can find that ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/CirclesUBI/circles-contracts/blob/master/build/contracts/Token.json"},"on the ",(0,s.kt)("em",{parentName:"a"},"Circles")," github site"),". As of sbt-ethereum 0.5.3, we can just provide the URL to ABI importing tasks (",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/contract/abi.html#ethcontractabiimport"},(0,s.kt)("inlineCode",{parentName:"a"},"ethContractAbiImport"))," and ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/contract/abi.html#ethcontractabidefaultimport"},(0,s.kt)("inlineCode",{parentName:"a"},"ethContractAbiDefaultImport")),") and ",(0,s.kt)("em",{parentName:"p"},"sbt-ethereum")," will extract the ABI."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethContractAbiImport CRC-snoopy\nTo import an ABI, you may provide the JSON ABI directly, or else a file path or URL from which the ABI can be downloaded.\nContract ABI or Source: https://github.com/CirclesUBI/circles-contracts/blob/master/build/contracts/Token.json\n[info] Attempting to interactively import a contract ABI.\n[info] Checking to see if you have provided a JSON array or object directly.\n[info] The provided text does not appear to be a JSON ABI.\n[info] Checking if the provided source exists as a File.\n[info] No file found. Checking if the provided source is interpretable as a URL.\n[info] 'https://github.com/CirclesUBI/circles-contracts/blob/master/build/contracts/Token.json' was reinterpreted into raw URL 'https://raw.githubusercontent.com/CirclesUBI/circles-contracts/master/build/contracts/Token.json. Trying that, will retry provided URL if necessary.\n[info] Interpreted user-provided source as a URL. Attempting to fetch contents.\n[info] Found JSON object. Will look for an ABI under the key 'abi'.\n[info] The data discovered at source 'https://github.com/CirclesUBI/circles-contracts/blob/master/build/contracts/Token.json' was successfully interpreted as an ABI.\nReady to import the following ABI:\n")),(0,s.kt)("details",null,(0,s.kt)("summary",null,(0,s.kt)("i",null,"Show ABI")),(0,s.kt)("div",null,(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'[ {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "_owner",\n    "type" : "address"l / Compile / ethContractAbiImport 0s\n  } ],\n  "stateMutability" : "nonpayable",\n  "type" : "constructor"\n}, {\n  "anonymous" : false,\n  "inputs" : [ {\n    "indexed" : true,\n    "internalType" : "address",\n    "name" : "owner",\n    "type" : "address"\n  }, {\n    "indexed" : true,\n    "internalType" : "address",\n    "name" : "spender",\n    "type" : "address"\n  }, {\n    "indexed" : false,\n    "internalType" : "uint256",\n    "name" : "value",\n    "type" : "uint256"\n  } ],\n  "name" : "Approval",\n  "type" : "event"\n}, {\n  "anonymous" : false,\n  "inputs" : [ {\n    "indexed" : true,\n    "internalType" : "address",\n    "name" : "from",\n    "type" : "address"\n  }, {\n    "indexed" : true,\n    "internalType" : "address",\n    "name" : "to",\n    "type" : "address"\n  }, {\n    "indexed" : false,\n    "internalType" : "uint256",\n    "name" : "value",\n    "type" : "uint256"\n  } ],\n  "name" : "Transfer",\n  "type" : "event"\n}, {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "owner",\n    "type" : "address"\n  }, {\n    "internalType" : "address",\n    "name" : "spender",\n    "type" : "address"\n  } ],\n  "name" : "allowance",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "spender",\n    "type" : "address"\n  }, {\n    "internalType" : "uint256",\n    "name" : "amount",\n    "type" : "uint256"\n  } ],\n  "name" : "approve",\n  "outputs" : [ {\n    "internalType" : "bool",\n    "name" : "",\n    "type" : "bool"\n  } ],\n  "stateMutability" : "nonpayable",\n  "type" : "function"\n}, {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "account",\n    "type" : "address"\n  } ],\n  "name" : "balanceOf",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "currentIssuance",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "decimals",\n  "outputs" : [ {\n    "internalType" : "uint8",\n    "name" : "",\n    "type" : "uint8"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "spender",\n    "type" : "address"\n  }, {\n    "internalType" : "uint256",\n    "name" : "subtractedValue",\n    "type" : "uint256"\n  } ],\n  "name" : "decreaseAllowance",\n  "outputs" : [ {\n    "internalType" : "bool",\n    "name" : "",\n    "type" : "bool"\n  } ],\n  "stateMutability" : "nonpayable",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "hub",\n  "outputs" : [ {\n    "internalType" : "address",\n    "name" : "",\n    "type" : "address"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "spender",\n    "type" : "address"\n  }, {\n    "internalType" : "uint256",\n    "name" : "addedValue",\n    "type" : "uint256"\n  } ],\n  "name" : "increaseAllowance",\n  "outputs" : [ {\n    "internalType" : "bool",\n    "name" : "",\n    "type" : "bool"\n  } ],\n  "stateMutability" : "nonpayable",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "inflationOffset",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "lastTouched",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "owner",\n  "outputs" : [ {\n    "internalType" : "address",\n    "name" : "",\n    "type" : "address"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "totalSupply",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "sender",\n    "type" : "address"\n  }, {\n    "internalType" : "address",\n    "name" : "recipient",\n    "type" : "address"\n  }, {\n    "internalType" : "uint256",\n    "name" : "amount",\n    "type" : "uint256"\n  } ],\n  "name" : "transferFrom",\n  "outputs" : [ {\n    "internalType" : "bool",\n    "name" : "",\n    "type" : "bool"\n  } ],\n  "stateMutability" : "nonpayable",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "time",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "symbol",\n  "outputs" : [ {\n    "internalType" : "string",\n    "name" : "",\n    "type" : "string"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "name",\n  "outputs" : [ {\n    "internalType" : "string",\n    "name" : "",\n    "type" : "string"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "period",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "periods",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "timeout",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "periodsWhenLastTouched",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "hubDeployedAt",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "stop",\n  "outputs" : [ ],\n  "stateMutability" : "nonpayable",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "stopped",\n  "outputs" : [ {\n    "internalType" : "bool",\n    "name" : "",\n    "type" : "bool"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "findInflationOffset",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "look",\n  "outputs" : [ {\n    "internalType" : "uint256",\n    "name" : "",\n    "type" : "uint256"\n  } ],\n  "stateMutability" : "view",\n  "type" : "function"\n}, {\n  "inputs" : [ ],\n  "name" : "update",\n  "outputs" : [ ],\n  "stateMutability" : "nonpayable",\n  "type" : "function"\n}, {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "from",\n    "type" : "address"\n  }, {\n    "internalType" : "address",\n    "name" : "to",\n    "type" : "address"\n  }, {\n    "internalType" : "uint256",\n    "name" : "amount",\n    "type" : "uint256"\n  } ],\n  "name" : "hubTransfer",\n  "outputs" : [ {\n    "internalType" : "bool",\n    "name" : "",\n    "type" : "bool"\n  } ],\n  "stateMutability" : "nonpayable",\n  "type" : "function"\n}, {\n  "inputs" : [ {\n    "internalType" : "address",\n    "name" : "dst",\n    "type" : "address"\n  }, {\n    "internalType" : "uint256",\n    "name" : "wad",\n    "type" : "uint256"\n  } ],\n  "name" : "transfer",\n  "outputs" : [ {\n    "internalType" : "bool",\n    "name" : "",\n    "type" : "bool"\n  } ],\n  "stateMutability" : "nonpayable",\n  "type" : "function"\n} ]\n')))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"Do you wish to import this ABi? [y/n] y\n[info] A default ABI is now known for the contract at address 0xf910549FdbA1083B7E515029601e8Bc748774C64\n[info] Refreshing caches.\n[success] Total time: 7 s, completed Mar 23, 2021, 12:06:23 AM\n")),(0,s.kt)("p",null,"Now we can see and use methods that are not standard to ERC-20 tokens. We can check-out the read-only methods with ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/transaction/index.html#ethtransactionview"},(0,s.kt)("inlineCode",{parentName:"a"},"ethTransactionView")),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionView CRC-snoopy <tab>\nallowance                balanceOf                currentIssuance          decimals                 findInflationOffset      \nhub                      hubDeployedAt            inflationOffset          lastTouched              look                     \nname                     owner                    period                   periods                  periodsWhenLastTouched   \nstopped                  symbol                   time                     timeout                  totalSupply              \n")),(0,s.kt)("p",null,"We can also check-out the methods that would modiy the blockchain and should be run in a transaction with ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/tasks/eth/transaction/index.html#ethtransactioninvoke"},(0,s.kt)("inlineCode",{parentName:"a"},"ethTransactionInvoke"))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionInvoke CRC-snoopy <tab>\napprove             decreaseAllowance   hubTransfer         increaseAllowance   stop                transfer            transferFrom        \nupdate              \u200b                    \n")),(0,s.kt)("p",null,"If we look at the h",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/23/(#Appendix-Circles-hub-source-code)"},"ub source code")," (which includes the source code for the ",(0,s.kt)("em",{parentName:"p"},"Circles")," tokens it produces), we\u2019ll learn that the read-only ",(0,s.kt)("inlineCode",{parentName:"p"},"look")," method tells us how much \u201cUBI\u201d a ",(0,s.kt)("em",{parentName:"p"},"Circles")," token in surrently entitled to, while the blockchain-modifying ",(0,s.kt)("inlineCode",{parentName:"p"},"update")," method actually delivers the new tokens. Let\u2019s try them out. First let\u2019s call look:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionView CRC-snoopy look\n[info] The function 'look' yields 1 result.\n[info]  + Result 1 of type 'uint256' is 16646759259259152720\n[success] Total time: 0 s, completed Mar 23, 2021, 12:21:33 AM\nsbt:circles-tutorial> \n")),(0,s.kt)("p",null,"Since ",(0,s.kt)("inlineCode",{parentName:"p"},"CRC-snoopy")," is an ",(0,s.kt)("a",{parentName:"p",href:"https://eips.ethereum.org/EIPS/eip-20"},"ERC-20 token with the standard 18 ",(0,s.kt)("inlineCode",{parentName:"a"},"decimals()")),", this will correspond to 16.67 tokens."),(0,s.kt)("p",null,"Now let\u2019s go ahead and call the blockchain-modifying function ",(0,s.kt)("inlineCode",{parentName:"p"},"update")," in a trasaction:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> ethTransactionInvoke CRC-snoopy update\n\n==> T R A N S A C T I O N   S I G N A T U R E   R E Q U E S T\n==>\n==> The transaction would be a message with...\n==>   To:    0xf910549FdbA1083B7E515029601e8Bc748774C64 (with aliases ['CRC-snoopy'] on chain with ID 100)\n==>   From:  0xB157256Af409007d903B443349bf49A9D6a1f519 (with aliases ['circles-snoopy','default-sender'] on chain with ID 100)\n==>   Data:  0xa2e62045\n==>   Value: 0 etherial / Compile / ethTransactionInvoke 0s\n==>\n==> According to the ABI currently associated with the 'to' address, this message would amount to the following method call...\n==>   Function called: update()\n==>\n==> The nonce of the transaction would be 3.\n==>\n==> $$$ The transaction you have requested could use up to 90590 units of gas.\n==> $$$ You would pay 10 gwei for each unit of gas, for a maximum cost of 0.0009059 ether.\n==> $$$ (No USD value could be determined for ETH on chain with ID 100 from Coinbase).\n\nWould you like to sign this transaction? [y/n] y\n\n[info] Unlocking address '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100).\nEnter passphrase or hex private key for address '0xB157256Af409007d903B443349bf49A9D6a1f519': ************************\n[info] Called function 'update', with args '', sending 0 wei to address '0xf910549FdbA1083B7E515029601e8Bc748774C64' in transaction with hash '0x70acc6f45712f2b5e8ab7c2e052a22fa70df2d8c484751ddd1a4d873606e977b'.\n[info] Waiting for the transaction to be mined (will wait up to 5 minutes).\n[info] Transaction Receipt:\n[info]        Transaction Hash:    0x70acc6f45712f2b5e8ab7c2e052a22fa70df2d8c484751ddd1a4d873606e977b\n[info]        Transaction Index:   1\n[info]        Transaction Status:  SUCCEEDED\n[info]        Block Hash:          0xc5e83a56b6d8cb49f6d2d32b11c64bfc48632cd21f57804422826368a881067c\n[info]        Block Number:        15152993\n[info]        From:                0xB157256Af409007d903B443349bf49A9D6a1f519\n[info]        To:                  0xf910549FdbA1083B7E515029601e8Bc748774C64\n[info]        Cumulative Gas Used: 1003680\n[info]        Gas Used:            73924\n[info]        Contract Address:    None\n[info]        Logs:                0 => EthLogEntry [source=0xf910549FdbA1083B7E515029601e8Bc748774C64] (\n[info]                                    topics=[\n[info]                                      0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef,\n[info]                                      0x0000000000000000000000000000000000000000000000000000000000000000,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519\n[info]                                    ],\n[info]                                    data=000000000000000000000000000000000000000000000000e7663606ffbaab00\n[info]                                  )\n[info]        Events:              0 => Transfer [source=0xf910549FdbA1083B7E515029601e8Bc748774C64] (\n[info]                                    from (of type address): 0x0000000000000000000000000000000000000000,\n[info]                                    to (of type address): 0xB157256Af409007d903B443349bf49A9D6a1f519,\n[info]                                    value (of type uint256): 16674074074073967360\n[info]                                  )\n[success] Total time: 40 s, completed Mar 23, 2021, 12:26:28 AM\n")),(0,s.kt)("p",null,"Excellent. It looks like it succeeded. Now let\u2019s check ",(0,s.kt)("inlineCode",{parentName:"p"},"CRC-snoopy"),"\u2018s balance:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:circles-tutorial> erc20Balance CRC-snoopy\n[info] For ERC20 Token Contract '0xf910549FdbA1083B7E515029601e8Bc748774C64' (with aliases ['CRC-snoopy'] on chain with ID 100), with 18 decimals...\n[info]   For Address '0xB157256Af409007d903B443349bf49A9D6a1f519' (with aliases ['circles-snoopy','default-sender'] on chain with ID 100))...\n[info]     Balance: 65.67407407407396736 tokens (which corresponds to 65674074074073967360 atoms)\n[success] Total time: 1 s, completed Mar 23, 2021, 12:28:24 AM\n")),(0,s.kt)("p",null,"It\u2019s been credited with the expected additional 16.67 tokens. Yay UBI!"),(0,s.kt)("h2",{id:"using-transferthrough-to-make-a-hub-transfer"},"Using ",(0,s.kt)("inlineCode",{parentName:"h2"},"transferThrough")," to make a \u201chub transfer\u201d"),(0,s.kt)("p",null,"You can send your ",(0,s.kt)("em",{parentName:"p"},"Circles")," tokens to any ",(0,s.kt)("em",{parentName:"p"},"Ethereum")," address. You can receive ",(0,s.kt)("em",{parentName:"p"},"Circles")," tokens from any ",(0,s.kt)("em",{parentName:"p"},"Ethereum")," address. But given how easy it is to create a new identity endowed with ",(0,s.kt)("em",{parentName:"p"},"Circles")," tokens, if someone sends you some random ",(0,s.kt)("em",{parentName:"p"},"Circles")," tokens, you shouldn\u2019t feel very much obliged to provide some form of value to reciprocate for the value received."),(0,s.kt)("p",null,"However, if you receive tokens from an address that you\u2019ve trusted, directly or indirectly according to the rules of the ",(0,s.kt)("em",{parentName:"p"},"Circles")," app, then you are arguably duty bound to treat those tokens as if they were as valuable as your own, so ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/14/Circles-with-sbt-ethereum.html"},"to provide value or perform a favor as if the payer had redeemed one of your own tokens"),"."),(0,s.kt)("p",null,"If you wish to pay a ",(0,s.kt)("em",{parentName:"p"},"Circles")," participant in a way that makes clear that your token is trusted and should be honored, you can perform a ",(0,s.kt)("em",{parentName:"p"},"hub transfer"),". When you do so, you specify the ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/14/Circles-with-sbt-ethereum.html"},"trust path")," through which your tokens will travel, and the transfer will only succeed if the hub smart contract can validate that path."),(0,s.kt)("p",null,"In this tutorial, the identity ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy")," trusted my real identity ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-steve (0x647E68F4BCBC843F39c80bb02da96dD13308f657)"),"."),(0,s.kt)("p",null,"From my main environment (rather than the temporary shoebox I\u2019ve used for this exercise), I call ",(0,s.kt)("inlineCode",{parentName:"p"},"transferThrough"),"beginning with my own ",(0,s.kt)("em",{parentName:"p"},"Circles")," tokens, ending with ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-snoopy"),", generating a hub transfer event. The syntax will be a bit arcane, though. And note the different environment we\u2019re in, different project, different sender, different aliases. (",(0,s.kt)("inlineCode",{parentName:"p"},"circles-steve")," is ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-identity")," here; ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-hub")," is ",(0,s.kt)("inlineCode",{parentName:"p"},"gnosis-circles-hub"),".)"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"sbt:eth-command-line> ethNodeChainIdOverride 100\n[info] The chain ID has been overridden to 100.\n[info] The session is now active on chain with ID 100, with node URL 'https://rpc.xdaichain.com/'.\n[info] The current session sender is '0x72a8a15ECa1f824ADE35cdEB2148223402f23448' (with aliases ['default-sender','testing-xDAI'] on chain with ID 100).\n[info] The current default gas price according to your node is 20 gwei. (THIS MAY CHANGE AT ANY TIME.)\n[info] Refreshing caches.\n[success] Total time: 1 s, completed Mar 23, 2021, 12:50:00 AM\nsbt:eth-command-line> ethAddressSenderOverride circles-identity\n[info] Sender override set to '0x647E68F4BCBC843F39c80bb02da96dD13308f657' (on chain with ID 100, aliases ['circles-identity'])).\n[success] Total time: 0 s, completed Mar 23, 2021, 12:50:17 AM\nsbt:eth-command-line> eth\n[info] The session is now active on chain with ID 100, with node URL 'https://rpc.xdaichain.com/'.\n[info] The current session sender is '0x647E68F4BCBC843F39c80bb02da96dD13308f657' (with aliases ['circles-identity'] on chain with ID 100).\n[info] The current default gas price according to your node is 20 gwei. (THIS MAY CHANGE AT ANY TIME.)\n[warn] NOTE: The sender has been overridden to '0x647E68F4BCBC843F39c80bb02da96dD13308f657' (with aliases ['circles-identity'] on chain with ID 100).\n[success] Total time: 0 s, completed Mar 23, 2021, 12:50:22 AM\nsbt:eth-command-line> ethAddressAliasSet circles-snoopy 0xB157256Af409007d903B443349bf49A9D6a1f519\n[info] Alias 'circles-snoopy' now points to address '0xB157256Af409007d903B443349bf49A9D6a1f519' (for chain with ID 100).\n[info] Refreshing caches.\n[success] Total time: 0 s, completed Mar 23, 2021, 12:51:45 AM\nsbt:eth-command-line> ethTransactionInvoke gnosis-circles-hub transferThrough [0x647E68F4BCBC843F39c80bb02da96dD13308f657] [0x647E68F4BCBC843F39c80bb02da96dD13308f657] [0xB157256Af409007d903B443349bf49A9D6a1f519] [1000000000000000000]\n\n==> T R A N S A C T I O N   S I G N A T U R E   R E Q U E S T\n==>\n==> The transaction would be a message with...\n==>   To:    0x29b9a7fBb8995b2423a71cC17cf9810798F6C543 (with aliases ['gnosis-circles-hub'] on chain with ID 100)\n==>   From:  0x647E68F4BCBC843F39c80bb02da96dD13308f657 (with aliases ['circles-identity'] on chain with ID 100)\n==>   Data:  0xd62fd9a2000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000647e68f4bcbc843f39c80bb02da96dd13308f6570000000000000000000000000000000000000000000000000000000000000001000000000000000000000000647e68f4bcbc843f39c80bb02da96dd13308f6570000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b157256af409007d903b443349bf49a9d6a1f51900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a7640000\n==>   Value: 0 ether\n==>\n==> According to the ABI currently associated with the 'to' address, this message would amount to the following method call...\n==>   Function called: transferThrough(address[],address[],address[],uint256[])\n==>     Arg 1 [name=tokenOwners, type=address[]]: [0x647E68F4BCBC843F39c80bb02da96dD13308f657]\n==>     Arg 2 [name=srcs, type=address[]]: [0x647E68F4BCBC843F39c80bb02da96dD13308f657]\n==>     Arg 3 [name=dests, type=address[]]: [0xB157256Af409007d903B443349bf49A9D6a1f519]\n==>     Arg 4 [name=wads, type=uint256[]]: [1000000000000000000]\n==>\n==> The nonce of the transaction would be 8.\n==>\n==> $$$ The transaction you have requested could use up to 317089 units of gas.\n==> $$$ You would pay 20 gwei for each unit of gas, for a maximum cost of 0.00634178 ether.\n==> $$$ (No USD value could be determined for ETH on chain with ID 100 from Coinbase).\n\nWould you like to sign this transaction? [y/n] y\n\n[info] Unlocking address '0x647E68F4BCBC843F39c80bb02da96dD13308f657' (with aliases ['circles-identity'] on chain with ID 100).\nEnter passphrase or hex private key for address '0x647E68F4BCBC843F39c80bb02da96dD13308f657': ************************\n[info] Called function 'transferThrough', with args '[0x647E68F4BCBC843F39c80bb02da96dD13308f657], [0x647E68F4BCBC843F39c80bb02da96dD13308f657], [0xB157256Af409007d903B443349bf49A9D6a1f519], [1000000000000000000]', sending 0 wei to address '0x29b9a7fBb8995b2423a71cC17cf9810798F6C543' in transaction with hash '0x19df802de1068e648f55b949a38f5516f5a824684ae884534d65b31b5b0a9edc'.\n[info] Waiting for the transaction to be mined (will wait up to 5 minutes).\n[info] Transaction Receipt:\n[info]        Transaction Hash:    0x19df802de1068e648f55b949a38f5516f5a824684ae884534d65b31b5b0a9edc\n[info]        Transaction Index:   1\n[info]        Transaction Status:  SUCCEEDED\n[info]        Block Hash:          0x4fd82c1e996b947781d00280b7ce1dd5755d2d1dadc11158605bf411bc04c710\n[info]        Block Number:        15153387\n[info]        From:                0x647E68F4BCBC843F39c80bb02da96dD13308f657\n[info]        To:                  0x29b9a7fBb8995b2423a71cC17cf9810798F6C543\n[info]        Cumulative Gas Used: 211987\n[info]        Gas Used:            131831\n[info]        Contract Address:    None\n[info]        Logs:                0 => EthLogEntry [source=0x6B378dB654BA05395D7615Be0F07ac1B3cC9ac74] (\n[info]                                    topics=[\n[info]                                      0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef,\n[info]                                      0x000000000000000000000000647e68f4bcbc843f39c80bb02da96dd13308f657,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519\n[info]                                    ],\n[info]                                    data=0000000000000000000000000000000000000000000000000de0b6b3a7640000\n[info]                                  ),\n[info]                             1 => EthLogEntry [source=0x29b9a7fBb8995b2423a71cC17cf9810798F6C543] (\n[info]                                    topics=[\n[info]                                      0x8451019aab65b4193860ef723cb0d56b475a26a72b7bfc55c1dbd6121015285a,\n[info]                                      0x000000000000000000000000647e68f4bcbc843f39c80bb02da96dd13308f657,\n[info]                                      0x000000000000000000000000b157256af409007d903b443349bf49a9d6a1f519\n[info]                                    ],\n[info]                                    data=0000000000000000000000000000000000000000000000000de0b6b3a7640000\n[info]                                  )\n[info]        Events:              0 => Anonymous Event [source=0x6B378dB654BA05395D7615Be0F07ac1B3cC9ac74],\n[info]                             1 => HubTransfer [source=0x29b9a7fBb8995b2423a71cC17cf9810798F6C543] (\n[info]                                    from (of type address): 0x647E68F4BCBC843F39c80bb02da96dD13308f657,\n[info]                                    to (of type address): 0xB157256Af409007d903B443349bf49A9D6a1f519,\n[info]                                    amount (of type uint256): 1000000000000000000\n[info]                                  )\n[success] Total time: 32 s, completed Mar 23, 2021, 12:59:24 AM\n")),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"tranferThrough")," call is a bit difficult to understand, for two reasons. Let\u2019s look at the function signature:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"/// @notice walks through tokenOwners, srcs, dests, and amounts array and executes transtive transfer\n/// @dev tokenOwners[0], srcs[0], dests[0], and wads[0] constitute a transaction step\n/// @param tokenOwners the owner of the tokens being sent in each transaction step\n/// @param srcs the sender of each transaction step\n/// @param dests the recipient of each transaction step\n/// @param wads the amount for each transaction step\nfunction transferThrough(\n    address[] memory tokenOwners,\n    address[] memory srcs,\n    address[] memory dests,\n    uint[] memory wads\n) public\n")),(0,s.kt)("p",null,"Instead of transfering from one party to another in the usual ERC-20 way, here we specify potentially a series of one-to-one token exchanged between trusted parties until finally the last payer (the last element in ",(0,s.kt)("inlineCode",{parentName:"p"},"srcs"),") pays the final recipient (the last element of ",(0,s.kt)("inlineCode",{parentName:"p"},"dests"),"). So we have to specify not a single transfer, but (potentially) a whole sequence. That\u2019s why we have an array of sources, destinations, coins (identified by their owners), and amounts, rather than a single transfer."),(0,s.kt)("p",null,"This would always be a complicated function, but it looks even more arcane than it needs to, because ",(0,s.kt)("strong",{parentName:"p"},(0,s.kt)("em",{parentName:"strong"},"sbt-ethereum"))," ",(0,s.kt)("strong",{parentName:"p"},"doesn\u2019t (yet) support resolution of address aliases within array brackets"),". So we had to supply all the addresses in the arguments as hex. This is\u2026 not ideal."),(0,s.kt)("p",null,"But. We did manage to execute ",(0,s.kt)("inlineCode",{parentName:"p"},"transferThrough"),", generating a hub transfer event, signalling to the final recipient that, not only did she receive tokens, but she received a token that directly or indirectly she has promised to trust and treat as on par with her own. She is, arguably, duty bound to provide some value in return for this transfer, in a way she would not be from some unsolicited \u201cordinary\u201d transfer."),(0,s.kt)("h2",{id:"conclusion"},"Conclusion"),(0,s.kt)("p",null,"So, we\u2019ve succeeded \u201cby hand\u201d at creating an identity, funding it on the xDAI block chain, and signing it up for ",(0,s.kt)("em",{parentName:"p"},"Circles")," on the hub contract. That generated a new ERC-20 token, of which our registered identity had an initial balance of 50 tokens. But, so long as anybody periodically \u201ctouches\u201d the token contract by calling ",(0,s.kt)("inlineCode",{parentName:"p"},"update"),", we\u2019ve seen that ",(0,s.kt)("inlineCode",{parentName:"p"},"circles-identity"),"\u2018s balance will grow over time, receiving its \u201cUBI\u201d in its own scrip."),(0,s.kt)("p",null,"We\u2019ve also seen that we can trust other identities, fully or partially, to define the \u201ccircles of trust\u201d through which \u201chub transfers\u201d occur. Although you can send ",(0,s.kt)("em",{parentName:"p"},"Circles")," tokens to, or receive them from, any address, \u201chub transfers\u201d have a special meaning. If you receive a token by hub transfer, it means that you\u2019ve been paid by someone whose tokens you\u2019ve directly or indirectly promised to honor. In theory, you ",(0,s.kt)("a",{parentName:"p",href:"https://www.sbt-ethereum.io/blog/2021/03/14/Circles-with-sbt-ethereum.html"},"owe them a favor in return"),"."),(0,s.kt)("h2",{id:"appendix-circles-hub-source-code"},"Appendix: Circles hub source code"),(0,s.kt)("details",null,(0,s.kt)("summary",null,"Click here to show the full source code of the Circles hub. It includes the source code of the generated ERC-20 token contracts."),(0,s.kt)("div",null,(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'// File: @openzeppelin/contracts/math/SafeMath.sol\n\npragma solidity ^0.7.0;\n\n/**\n * @dev Wrappers over Solidity\'s arithmetic operations with added overflow\n * checks.\n *\n * Arithmetic operations in Solidity wrap on overflow. This can easily result\n * in bugs, because programmers usually assume that an overflow raises an\n * error, which is the standard behavior in high level programming languages.\n * `SafeMath` restores this intuition by reverting the transaction when an\n * operation overflows.\n *\n * Using this library instead of the unchecked operations eliminates an entire\n * class of bugs, so it\'s recommended to use it always.\n */\nlibrary SafeMath {\n    /**\n     * @dev Returns the addition of two unsigned integers, reverting on\n     * overflow.\n     *\n     * Counterpart to Solidity\'s `+` operator.\n     *\n     * Requirements:\n     *\n     * - Addition cannot overflow.\n     */\n    function add(uint256 a, uint256 b) internal pure returns (uint256) {\n        uint256 c = a + b;\n        require(c >= a, "SafeMath: addition overflow");\n\n        return c;\n    }\n\n    /**\n     * @dev Returns the subtraction of two unsigned integers, reverting on\n     * overflow (when the result is negative).\n     *\n     * Counterpart to Solidity\'s `-` operator.\n     *\n     * Requirements:\n     *\n     * - Subtraction cannot overflow.\n     */\n    function sub(uint256 a, uint256 b) internal pure returns (uint256) {\n        return sub(a, b, "SafeMath: subtraction overflow");\n    }\n\n    /**\n     * @dev Returns the subtraction of two unsigned integers, reverting with custom message on\n     * overflow (when the result is negative).\n     *\n     * Counterpart to Solidity\'s `-` operator.\n     *\n     * Requirements:\n     *\n     * - Subtraction cannot overflow.\n     */\n    function sub(uint256 a, uint256 b, string memory errorMessage) internal pure returns (uint256) {\n        require(b <= a, errorMessage);\n        uint256 c = a - b;\n\n        return c;\n    }\n\n    /**\n     * @dev Returns the multiplication of two unsigned integers, reverting on\n     * overflow.\n     *\n     * Counterpart to Solidity\'s `*` operator.\n     *\n     * Requirements:\n     *\n     * - Multiplication cannot overflow.\n     */\n    function mul(uint256 a, uint256 b) internal pure returns (uint256) {\n        // Gas optimization: this is cheaper than requiring \'a\' not being zero, but the\n        // benefit is lost if \'b\' is also tested.\n        // See: https://github.com/OpenZeppelin/openzeppelin-contracts/pull/522\n        if (a == 0) {\n            return 0;\n        }\n\n        uint256 c = a * b;\n        require(c / a == b, "SafeMath: multiplication overflow");\n\n        return c;\n    }\n\n    /**\n     * @dev Returns the integer division of two unsigned integers. Reverts on\n     * division by zero. The result is rounded towards zero.\n     *\n     * Counterpart to Solidity\'s `/` operator. Note: this function uses a\n     * `revert` opcode (which leaves remaining gas untouched) while Solidity\n     * uses an invalid opcode to revert (consuming all remaining gas).\n     *\n     * Requirements:\n     *\n     * - The divisor cannot be zero.\n     */\n    function div(uint256 a, uint256 b) internal pure returns (uint256) {\n        return div(a, b, "SafeMath: division by zero");\n    }\n\n    /**\n     * @dev Returns the integer division of two unsigned integers. Reverts with custom message on\n     * division by zero. The result is rounded towards zero.\n     *\n     * Counterpart to Solidity\'s `/` operator. Note: this function uses a\n     * `revert` opcode (which leaves remaining gas untouched) while Solidity\n     * uses an invalid opcode to revert (consuming all remaining gas).\n     *\n     * Requirements:\n     *\n     * - The divisor cannot be zero.\n     */\n    function div(uint256 a, uint256 b, string memory errorMessage) internal pure returns (uint256) {\n        require(b > 0, errorMessage);\n        uint256 c = a / b;\n        // assert(a == b * c + a % b); // There is no case in which this doesn\'t hold\n\n        return c;\n    }\n\n    /**\n     * @dev Returns the remainder of dividing two unsigned integers. (unsigned integer modulo),\n     * Reverts when dividing by zero.\n     *\n     * Counterpart to Solidity\'s `%` operator. This function uses a `revert`\n     * opcode (which leaves remaining gas untouched) while Solidity uses an\n     * invalid opcode to revert (consuming all remaining gas).\n     *\n     * Requirements:\n     *\n     * - The divisor cannot be zero.\n     */\n    function mod(uint256 a, uint256 b) internal pure returns (uint256) {\n        return mod(a, b, "SafeMath: modulo by zero");\n    }\n\n    /**\n     * @dev Returns the remainder of dividing two unsigned integers. (unsigned integer modulo),\n     * Reverts with custom message when dividing by zero.\n     *\n     * Counterpart to Solidity\'s `%` operator. This function uses a `revert`\n     * opcode (which leaves remaining gas untouched) while Solidity uses an\n     * invalid opcode to revert (consuming all remaining gas).\n     *\n     * Requirements:\n     *\n     * - The divisor cannot be zero.\n     */\n    function mod(uint256 a, uint256 b, string memory errorMessage) internal pure returns (uint256) {\n        require(b != 0, errorMessage);\n        return a % b;\n    }\n}\n\n// File: @openzeppelin/contracts/utils/Address.sol\n\npragma solidity ^0.7.0;\n\n/**\n * @dev Collection of functions related to the address type\n */\nlibrary Address {\n    /**\n     * @dev Returns true if `account` is a contract.\n     *\n     * [IMPORTANT]\n     * ====\n     * It is unsafe to assume that an address for which this function returns\n     * false is an externally-owned account (EOA) and not a contract.\n     *\n     * Among others, `isContract` will return false for the following\n     * types of addresses:\n     *\n     *  - an externally-owned account\n     *  - a contract in construction\n     *  - an address where a contract will be created\n     *  - an address where a contract lived, but was destroyed\n     * ====\n     */\n    function isContract(address account) internal view returns (bool) {\n        // According to EIP-1052, 0x0 is the value returned for not-yet created accounts\n        // and 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470 is returned\n        // for accounts without code, i.e. `keccak256(\'\')`\n        bytes32 codehash;\n        bytes32 accountHash = 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470;\n        // solhint-disable-next-line no-inline-assembly\n        assembly { codehash := extcodehash(account) }\n        return (codehash != accountHash && codehash != 0x0);\n    }\n\n    /**\n     * @dev Replacement for Solidity\'s `transfer`: sends `amount` wei to\n     * `recipient`, forwarding all available gas and reverting on errors.\n     *\n     * https://eips.ethereum.org/EIPS/eip-1884[EIP1884] increases the gas cost\n     * of certain opcodes, possibly making contracts go over the 2300 gas limit\n     * imposed by `transfer`, making them unable to receive funds via\n     * `transfer`. {sendValue} removes this limitation.\n     *\n     * https://diligence.consensys.net/posts/2019/09/stop-using-soliditys-transfer-now/[Learn more].\n     *\n     * IMPORTANT: because control is transferred to `recipient`, care must be\n     * taken to not create reentrancy vulnerabilities. Consider using\n     * {ReentrancyGuard} or the\n     * https://solidity.readthedocs.io/en/v0.5.11/security-considerations.html#use-the-checks-effects-interactions-pattern[checks-effects-interactions pattern].\n     */\n    function sendValue(address payable recipient, uint256 amount) internal {\n        require(address(this).balance >= amount, "Address: insufficient balance");\n\n        // solhint-disable-next-line avoid-low-level-calls, avoid-call-value\n        (bool success, ) = recipient.call{ value: amount }("");\n        require(success, "Address: unable to send value, recipient may have reverted");\n    }\n\n    /**\n     * @dev Performs a Solidity function call using a low level `call`. A\n     * plain`call` is an unsafe replacement for a function call: use this\n     * function instead.\n     *\n     * If `target` reverts with a revert reason, it is bubbled up by this\n     * function (like regular Solidity function calls).\n     *\n     * Returns the raw returned data. To convert to the expected return value,\n     * use https://solidity.readthedocs.io/en/latest/units-and-global-variables.html?highlight=abi.decode#abi-encoding-and-decoding-functions[`abi.decode`].\n     *\n     * Requirements:\n     *\n     * - `target` must be a contract.\n     * - calling `target` with `data` must not revert.\n     *\n     * _Available since v3.1._\n     */\n    function functionCall(address target, bytes memory data) internal returns (bytes memory) {\n      return functionCall(target, data, "Address: low-level call failed");\n    }\n\n    /**\n     * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`], but with\n     * `errorMessage` as a fallback revert reason when `target` reverts.\n     *\n     * _Available since v3.1._\n     */\n    function functionCall(address target, bytes memory data, string memory errorMessage) internal returns (bytes memory) {\n        return _functionCallWithValue(target, data, 0, errorMessage);\n    }\n\n    /**\n     * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`],\n     * but also transferring `value` wei to `target`.\n     *\n     * Requirements:\n     *\n     * - the calling contract must have an ETH balance of at least `value`.\n     * - the called Solidity function must be `payable`.\n     *\n     * _Available since v3.1._\n     */\n    function functionCallWithValue(address target, bytes memory data, uint256 value) internal returns (bytes memory) {\n        return functionCallWithValue(target, data, value, "Address: low-level call with value failed");\n    }\n\n    /**\n     * @dev Same as {xref-Address-functionCallWithValue-address-bytes-uint256-}[`functionCallWithValue`], but\n     * with `errorMessage` as a fallback revert reason when `target` reverts.\n     *\n     * _Available since v3.1._\n     */\n    function functionCallWithValue(address target, bytes memory data, uint256 value, string memory errorMessage) internal returns (bytes memory) {\n        require(address(this).balance >= value, "Address: insufficient balance for call");\n        return _functionCallWithValue(target, data, value, errorMessage);\n    }\n\n    function _functionCallWithValue(address target, bytes memory data, uint256 weiValue, string memory errorMessage) private returns (bytes memory) {\n        require(isContract(target), "Address: call to non-contract");\n\n        // solhint-disable-next-line avoid-low-level-calls\n        (bool success, bytes memory returndata) = target.call{ value: weiValue }(data);\n        if (success) {\n            return returndata;\n        } else {\n            // Look for revert reason and bubble it up if present\n            if (returndata.length > 0) {\n                // The easiest way to bubble the revert reason is using memory via assembly\n\n                // solhint-disable-next-line no-inline-assembly\n                assembly {\n                    let returndata_size := mload(returndata)\n                    revert(add(32, returndata), returndata_size)\n                }\n            } else {\n                revert(errorMessage);\n            }\n        }\n    }\n}\n\n// File: contracts/ERC20.sol\n\n// Based on @openzeppelin/contracts/token/ERC20/ERC20.sol\n\npragma solidity ^0.7.0;\n\n\n\n/**\n * @dev Implementation of the {IERC20} interface.\n *\n * This implementation is agnostic to the way tokens are created. This means\n * that a supply mechanism has to be added in a derived contract using {_mint}.\n * For a generic mechanism see {ERC20PresetMinterPauser}.\n *\n * TIP: For a detailed writeup see our guide\n * https://forum.zeppelin.solutions/t/how-to-implement-erc20-supply-mechanisms/226[How\n * to implement supply mechanisms].\n *\n * We have followed general OpenZeppelin guidelines: functions revert instead\n * of returning `false` on failure. This behavior is nonetheless conventional\n * and does not conflict with the expectations of ERC20 applications.\n *\n * Additionally, an {Approval} event is emitted on calls to {transferFrom}.\n * This allows applications to reconstruct the allowance for all accounts just\n * by listening to said events. Other implementations of the EIP may not emit\n * these events, as it isn\'t required by the specification.\n *\n * Finally, the non-standard {decreaseAllowance} and {increaseAllowance}\n * functions have been added to mitigate the well-known issues around setting\n * allowances. See {IERC20-approve}.\n */\n\ncontract ERC20 {\n    using SafeMath for uint256;\n    using Address for address;\n\n    mapping (address => uint256) private _balances;\n\n    mapping (address => mapping (address => uint256)) private _allowances;\n\n    uint256 private _totalSupply;\n\n    string private _symbol;\n    uint8 private _decimals;\n\n    /**\n     * @dev Emitted when `value` tokens are moved from one account (`from`) to\n     * another (`to`).\n     *\n     * Note that `value` may be zero.\n     */\n    event Transfer(address indexed from, address indexed to, uint256 value);\n\n    /**\n     * @dev Emitted when the allowance of a `spender` for an `owner` is set by\n     * a call to {approve}. `value` is the new allowance.\n     */\n    event Approval(address indexed owner, address indexed spender, uint256 value);\n\n    /**\n     * @dev Returns the symbol of the token, usually a shorter version of the\n     * name.\n     */\n    function symbol() external virtual view returns (string memory) {\n        return _symbol;\n    }\n\n    /**\n     * @dev Returns the number of decimals used to get its user representation.\n     * For example, if `decimals` equals `2`, a balance of `505` tokens should\n     * be displayed to a user as `5,05` (`505 / 10 ** 2`).\n     *\n     * Tokens usually opt for a value of 18, imitating the relationship between\n     * Ether and Wei. This is the value {ERC20} uses, unless {_setupDecimals} is\n     * called.\n     *\n     * NOTE: This information is only used for _display_ purposes: it in\n     * no way affects any of the arithmetic of the contract, including\n     * {IERC20-balanceOf} and {IERC20-transfer}.\n     */\n    function decimals() external virtual view returns (uint8) {\n        return _decimals;\n    }\n\n    /**\n     * @dev See {IERC20-totalSupply}.\n     */\n    function totalSupply() public view returns (uint256) {\n        return _totalSupply;\n    }\n\n    /**\n     * @dev See {IERC20-balanceOf}.\n     */\n    function balanceOf(address account) public view returns (uint256) {\n        return _balances[account];\n    }\n\n    /**\n     * @dev See {IERC20-transfer}.\n     *\n     * Requirements:\n     *\n     * - `recipient` cannot be the zero address.\n     * - the caller must have a balance of at least `amount`.\n     */\n    function transfer(address recipient, uint256 amount) public virtual returns (bool) {\n        _transfer(msg.sender, recipient, amount);\n        return true;\n    }\n\n    /**\n     * @dev See {IERC20-allowance}.\n     */\n    function allowance(address owner, address spender) public view virtual returns (uint256) {\n        return _allowances[owner][spender];\n    }\n\n    /**\n     * @dev See {IERC20-approve}.\n     *\n     * Requirements:\n     *\n     * - `spender` cannot be the zero address.\n     */\n    function approve(address spender, uint256 amount) public virtual returns (bool) {\n        _approve(msg.sender, spender, amount);\n        return true;\n    }\n\n    /**\n     * @dev See {IERC20-transferFrom}.\n     *\n     * Emits an {Approval} event indicating the updated allowance. This is not\n     * required by the EIP. See the note at the beginning of {ERC20};\n     *\n     * Requirements:\n     * - `sender` and `recipient` cannot be the zero address.\n     * - `sender` must have a balance of at least `amount`.\n     * - the caller must have allowance for ``sender``\'s tokens of at least\n     * `amount`.\n     */\n    function transferFrom(address sender, address recipient, uint256 amount) public virtual returns (bool) {\n        _transfer(sender, recipient, amount);\n        _approve(sender, msg.sender, _allowances[sender][msg.sender].sub(amount, "ERC20: transfer amount exceeds allowance"));\n        return true;\n    }\n\n    /**\n     * @dev Atomically increases the allowance granted to `spender` by the caller.\n     *\n     * This is an alternative to {approve} that can be used as a mitigation for\n     * problems described in {IERC20-approve}.\n     *\n     * Emits an {Approval} event indicating the updated allowance.\n     *\n     * Requirements:\n     *\n     * - `spender` cannot be the zero address.\n     */\n    function increaseAllowance(address spender, uint256 addedValue) public virtual returns (bool) {\n        _approve(msg.sender, spender, _allowances[msg.sender][spender].add(addedValue));\n        return true;\n    }\n\n    /**\n     * @dev Atomically decreases the allowance granted to `spender` by the caller.\n     *\n     * This is an alternative to {approve} that can be used as a mitigation for\n     * problems described in {IERC20-approve}.\n     *\n     * Emits an {Approval} event indicating the updated allowance.\n     *\n     * Requirements:\n     *\n     * - `spender` cannot be the zero address.\n     * - `spender` must have allowance for the caller of at least\n     * `subtractedValue`.\n     */\n    function decreaseAllowance(address spender, uint256 subtractedValue) public virtual returns (bool) {\n        _approve(msg.sender, spender, _allowances[msg.sender][spender].sub(subtractedValue, "ERC20: decreased allowance below zero"));\n        return true;\n    }\n\n    /**\n     * @dev Moves tokens `amount` from `sender` to `recipient`.\n     *\n     * This is internal function is equivalent to {transfer}, and can be used to\n     * e.g. implement automatic token fees, slashing mechanisms, etc.\n     *\n     * Emits a {Transfer} event.\n     *\n     * Requirements:\n     *\n     * - `sender` cannot be the zero address.\n     * - `recipient` cannot be the zero address.\n     * - `sender` must have a balance of at least `amount`.\n     */\n    function _transfer(address sender, address recipient, uint256 amount) internal virtual {\n        require(sender != address(0), "ERC20: transfer from the zero address");\n        require(recipient != address(0), "ERC20: transfer to the zero address");\n\n        _beforeTokenTransfer(sender, recipient, amount);\n\n        _balances[sender] = _balances[sender].sub(amount, "ERC20: transfer amount exceeds balance");\n        _balances[recipient] = _balances[recipient].add(amount);\n        emit Transfer(sender, recipient, amount);\n    }\n\n    /** @dev Creates `amount` tokens and assigns them to `account`, increasing\n     * the total supply.\n     *\n     * Emits a {Transfer} event with `from` set to the zero address.\n     *\n     * Requirements\n     *\n     * - `to` cannot be the zero address.\n     */\n    function _mint(address account, uint256 amount) internal virtual {\n        require(account != address(0), "ERC20: mint to the zero address");\n\n        _beforeTokenTransfer(address(0), account, amount);\n\n        _totalSupply = _totalSupply.add(amount);\n        _balances[account] = _balances[account].add(amount);\n        emit Transfer(address(0), account, amount);\n    }\n\n    /**\n     * @dev Destroys `amount` tokens from `account`, reducing the\n     * total supply.\n     *\n     * Emits a {Transfer} event with `to` set to the zero address.\n     *\n     * Requirements\n     *\n     * - `account` cannot be the zero address.\n     * - `account` must have at least `amount` tokens.\n     */\n    function _burn(address account, uint256 amount) internal virtual {\n        require(account != address(0), "ERC20: burn from the zero address");\n\n        _beforeTokenTransfer(account, address(0), amount);\n\n        _balances[account] = _balances[account].sub(amount, "ERC20: burn amount exceeds balance");\n        _totalSupply = _totalSupply.sub(amount);\n        emit Transfer(account, address(0), amount);\n    }\n\n    /**\n     * @dev Sets `amount` as the allowance of `spender` over the `owner`s tokens.\n     *\n     * This is internal function is equivalent to `approve`, and can be used to\n     * e.g. set automatic allowances for certain subsystems, etc.\n     *\n     * Emits an {Approval} event.\n     *\n     * Requirements:\n     *\n     * - `owner` cannot be the zero address.\n     * - `spender` cannot be the zero address.\n     */\n    function _approve(address owner, address spender, uint256 amount) internal virtual {\n        require(owner != address(0), "ERC20: approve from the zero address");\n        require(spender != address(0), "ERC20: approve to the zero address");\n\n        _allowances[owner][spender] = amount;\n        emit Approval(owner, spender, amount);\n    }\n\n    /**\n     * @dev Sets {decimals} to a value other than the default one of 18.\n     *\n     * WARNING: This function should only be called from the constructor. Most\n     * applications that interact with token contracts will not expect\n     * {decimals} to ever change, and may work incorrectly if it does.\n     */\n    function _setupDecimals(uint8 decimals_) internal {\n        _decimals = decimals_;\n    }\n\n    /**\n     * @dev Hook that is called before any transfer of tokens. This includes\n     * minting and burning.\n     *\n     * Calling conditions:\n     *\n     * - when `from` and `to` are both non-zero, `amount` of ``from``\'s tokens\n     * will be to transferred to `to`.\n     * - when `from` is zero, `amount` tokens will be minted for `to`.\n     * - when `to` is zero, `amount` of ``from``\'s tokens will be burned.\n     * - `from` and `to` are never both zero.\n     *\n     * To learn more about hooks, head to xref:ROOT:extending-contracts.adoc#using-hooks[Using Hooks].\n     */\n    function _beforeTokenTransfer(address from, address to, uint256 amount) internal virtual { }\n}\n\n// File: contracts/interfaces/HubI.sol\n\npragma solidity ^0.7.0;\n\ninterface HubI {\n    function issuance() external view returns (uint256);\n    function issuanceByStep(uint256) external view returns (uint256);\n    function inflation() external view returns (uint256);\n    function divisor() external view returns (uint256);\n    function period() external view returns (uint256);\n    function periods() external view returns (uint256);\n    function signupBonus() external view returns (uint256);\n    function pow(uint256, uint256) external view returns (uint256);\n    function totalSupply() external view returns (uint256);\n    function symbol() external view returns (string memory);\n    function name() external view returns (string memory);\n    function deployedAt() external view returns (uint256);\n    function inflate(uint256, uint256) external view returns (uint256);\n    function timeout() external view returns (uint256);\n}\n\n// File: contracts/Token.sol\n\npragma solidity ^0.7.0;\n\n\n\n\ncontract Token is ERC20 {\n    using SafeMath for uint256;\n\n    uint8 public immutable override decimals = 18;\n\n    uint256 public lastTouched; // the timestamp of the last ubi payout\n    address public hub; // the address of the hub this token was deployed through\n    address public immutable owner; // the safe that deployed this token\n    uint256 public inflationOffset; // the amount of seconds until the next inflation step\n    uint256 public currentIssuance; // issanceRate at the time this token was deployed\n    bool private manuallyStopped; // true if this token has been stopped by it\'s owner\n\n    /// @dev modifier allowing function to be only called through the hub\n    modifier onlyHub() {\n        require(msg.sender == hub);\n        _;\n    }\n\n    /// @dev modifier allowing function to be only called by the token owner\n    modifier onlyOwner() {\n        require(msg.sender == owner);\n        _;\n    }\n\n    constructor(address _owner) {\n        require(_owner != address(0));\n        owner = _owner;\n        hub = msg.sender;\n        lastTouched = time();\n        inflationOffset = findInflationOffset();\n        currentIssuance = HubI(hub).issuance();\n        _mint(_owner, HubI(hub).signupBonus());\n    }\n\n    /// @notice helper function for block timestamp\n    /// @return the block timestamp\n    function time() public view returns (uint) {\n        return block.timestamp;\n    }\n\n    /// @notice helper function for the token symbol\n    /// @dev all circles tokens should have the same symbol\n    /// @return the token symbol\n    function symbol() public view override returns (string memory) {\n        return HubI(hub).symbol();\n    }\n\n    /// @notice helper function for the token name\n    /// @dev all circles tokens should have the same name\n    /// @return the token name\n    function name() public view returns (string memory) {\n        return HubI(hub).name();\n    }\n\n    /// @notice helper function for fetching the period length from the hub\n    /// @return period length in seconds\n    function period() public view returns (uint256) {\n        return HubI(hub).period();\n    }\n\n    /// @notice helper function for fetching the number of periods from the hub\n    /// @return the number of periods since the hub was deployed\n    function periods() public view returns (uint256) {\n        return HubI(hub).periods();\n    }\n\n    /// @notice helper function for fetching the timeout from the hub\n    /// @return the number of seconds the token can go without being updated before it\'s deactivated\n    function timeout() public view returns (uint256) {\n        return HubI(hub).timeout();\n    }\n\n    /// @notice find the inflation step when ubi was last payed out\n    /// @dev ie. if ubi was last payed out during the second inflation step, returns two\n    /// @return the inflation step by count\n    function periodsWhenLastTouched() public view returns (uint256) {\n        return (lastTouched.sub(hubDeployedAt())).div(period());\n    }\n\n    /// @notice helper functio for getting the hub deployment time\n    /// @return the timestamp the hub was deployed at\n    function hubDeployedAt() public view returns (uint256) {\n        return HubI(hub).deployedAt();\n    }\n\n    /// @notice Caution! manually deactivates or stops this token, no ubi will be payed out after this is called\n    /// @dev intended for use in case of key loss, system failure, or migration to new contracts\n    function stop() public onlyOwner {\n        manuallyStopped = true;\n    }\n\n    /// @notice checks whether this token has been either stopped manually, or whether it has timed out\n    /// @dev combines the manual stop variable with a dead man\'s switch\n    /// @return true is the token is still paying out ubi, otherwise false\n    function stopped() public view returns (bool) {\n        if (manuallyStopped) return true;\n        uint256 secondsSinceLastTouched = time().sub(lastTouched);\n        if (secondsSinceLastTouched > timeout()) return true;\n        return false;\n    }\n\n    /// @notice the amount of seconds until the ubi payout is next inflated\n    /// @dev ubi is payed out continuously between inflation steps\n    /// @return the amount of seconds until the next inflation step\n    function findInflationOffset() public view returns (uint256) {\n        // finds the timestamp of the next inflation step, and subtracts the current timestamp\n        uint256 nextInflation = ((period().mul(periods().add(1))).add(hubDeployedAt()));\n        return nextInflation.sub(time());\n    }\n\n    /// @notice checks how much ubi this token holder is owed, but doesn\'t update their balance\n    /// @dev is called in the update method to write the new balance to state, but also useful in wallets\n    /// @return how much ubi this token holder is owed\n    function look() public view returns (uint256) {\n        // don\'t payout ubi if the token has been deactivated/stopped\n        if (stopped()) return 0;\n        uint256 payout = 0;\n        uint256 clock = lastTouched;\n        uint256 offset = inflationOffset;\n        uint256 rate = currentIssuance;\n        uint256 p = periodsWhenLastTouched();\n        // this while loop gets executed only when we\'re rolling over an inflation step \n        // in the course of a ubi payout aka while we have to pay out ubi for more time\n        // than lastTouched + inflationOffset\n        while (clock.add(offset) <= time()) {\n            // add the remaining offset time to the payout total at the current rate\n            payout = payout.add(offset.mul(rate));\n            // adjust clock to the timestamp of the next inflation step\n            clock = clock.add(offset);\n            // the offset is now the length of 1 period\n            offset = period();\n            // increment the period we are paying out for\n            p = p.add(1);\n            // find the issuance rate as of the next period\n            rate = HubI(hub).issuanceByStep(p);\n        }\n        // at this point, time() - clock should always be less than 1 period\n        uint256 timeSinceLastPayout = time().sub(clock);\n        payout = payout.add(timeSinceLastPayout.mul(rate));\n        return payout;\n    }\n\n    /// @notice receive a ubi payout\n    /// @dev this is the method to actually update storage with new token balance\n    function update() public {\n        uint256 gift = look();\n        // does nothing if there\'s no ubi to be payed out\n        if (gift > 0) {\n            // update the state variables used to calculate ubi, then mint\n            inflationOffset = findInflationOffset();\n            lastTouched = time();\n            currentIssuance = HubI(hub).issuance();\n            _mint(owner, gift);\n        }\n    }\n\n    /// @notice special method called by the hub to execute a transitive transaction\n    /// @param from the address the tokens are being transfered from\n    /// @param to the address the tokens are being transferred to\n    /// @param amount the amount of tokens to transfer\n    function hubTransfer(\n        address from, address to, uint256 amount\n    ) public onlyHub returns (bool) {\n        _transfer(from, to, amount);\n    }\n\n    function transfer(address dst, uint wad) public override returns (bool) {\n        // this code shouldn\'t be necessary, but when it\'s removed the gas estimation methods\n        // in the gnosis safe no longer work, still true as of solidity 7.1\n        return super.transfer(dst, wad);\n    }\n}\n\n// File: contracts/Hub.sol\n\npragma solidity ^0.7.0;\n\ncontract Hub {\n    using SafeMath for uint256;\n\n    uint256 public immutable inflation; // the inflation rate expressed as 1 + percentage inflation, aka 7% inflation is 107\n    uint256 public immutable divisor; // the largest power of 10 the inflation rate can be divided by\n    uint256 public immutable period; // the amount of sections between inflation steps\n    string public symbol;\n    string public name;\n    uint256 public immutable signupBonus; // a one-time payout made immediately on signup\n    uint256 public immutable initialIssuance; // the starting payout per second, this gets inflated by the inflation rate\n    uint256 public immutable deployedAt; // the timestamp this contract was deployed at\n    uint256 public immutable timeout; // longest a token can go without a ubi payout before it gets deactivated\n\n    mapping (address => Token) public userToToken;\n    mapping (address => address) public tokenToUser;\n    mapping (address => bool) public organizations;\n    mapping (address => mapping (address => uint256)) public limits;\n\n    event Signup(address indexed user, address token);\n    event OrganizationSignup(address indexed organization);\n    event Trust(address indexed canSendTo, address indexed user, uint256 limit);\n    event HubTransfer(address indexed from, address indexed to, uint256 amount);\n\n    // some data types used for validating transitive transfers\n    struct transferValidator {\n        bool seen;\n        uint256 sent;\n        uint256 received;\n    }\n    mapping (address => transferValidator) public validation;\n    address[] public seen;\n\n    constructor(\n        uint256 _inflation,\n        uint256 _period,\n        string memory _symbol,\n        string memory _name,\n        uint256 _signupBonus,\n        uint256 _initialIssuance,\n        uint256 _timeout\n    ) {\n        inflation = _inflation;\n        divisor = findDivisor(_inflation);\n        period = _period;\n        symbol = _symbol;\n        name = _name;\n        signupBonus = _signupBonus;\n        initialIssuance = _initialIssuance;\n        deployedAt = block.timestamp;\n        timeout = _timeout;\n    }\n\n    /// @notice calculates the correct divisor for the given inflation rate\n    /// @dev the divisor is used to maintain precision when doing math with percentages\n    /// @param _inf the inflation rate\n    /// @return the largest power of ten the inflation rate can be divided by\n    function findDivisor(uint256 _inf) internal pure returns (uint256) {\n        uint256 iter = 0;\n        while (_inf.div(pow(10, iter)) > 9) {\n            iter += 1;\n        }\n        return pow(10, iter);\n    }\n\n    /// @notice helper function for finding the amount of inflation periods since this hub was deployed\n    /// @return the amount of periods since hub was deployed\n    function periods() public view returns (uint256) {\n        return (block.timestamp.sub(deployedAt)).div(period);\n    }\n\n    /// @notice calculates the current issuance rate per second\n    /// @dev current issuance is the initial issuance inflated by the amount of inflation periods since the hub was deployed\n    /// @return current issuance rate\n    function issuance() public view returns (uint256) {\n        return inflate(initialIssuance, periods());\n    }\n\n    /// @notice finds the inflation rate at a given inflation period\n    /// @param _periods the step to calculate the issuance rate at\n    /// @return inflation rate as of the given period\n    function issuanceByStep(uint256 _periods) public view returns (uint256) {\n        return inflate(initialIssuance, _periods);\n    }\n\n    /// @notice find the current issuance rate for any initial issuance and amount of periods\n    /// @dev this is basically the calculation for compound interest, with some adjustments because of integer math\n    /// @param _initial the starting issuance rate\n    /// @param _periods the step to calculate the issuance rate as of\n    /// @return initial issuance rate as if interest (inflation) has been compounded period times\n    function inflate(uint256 _initial, uint256 _periods) public view returns (uint256) {\n        // this returns P * (1 + r) ** t - which is a the formula for compound interest if \n        // interest is compounded only once per period\n        // in our case, currentIssuanceRate = initialIssuance * (inflation) ** periods\n        uint256 q = pow(inflation, _periods);\n        uint256 d = pow(divisor, _periods);\n        return (_initial.mul(q)).div(d);\n    }\n\n    /// @notice signup to this circles hub - create a circles token and join the trust graph\n    /// @dev signup is permanent, there\'s no way to unsignup\n    function signup() public {\n        // signup can only be called once\n        require(address(userToToken[msg.sender]) == address(0), "You can\'t sign up twice");\n        // organizations cannot sign up for a token\n        require(organizations[msg.sender] == false, "Organizations cannot signup as normal users");\n\n        Token token = new Token(msg.sender);\n        userToToken[msg.sender] = token;\n        tokenToUser[address(token)] = msg.sender;\n        // every user must trust themselves with a weight of 100\n        // this is so that all users accept their own token at all times\n        _trust(msg.sender, 100);\n\n        emit Signup(msg.sender, address(token));\n    }\n\n    /// @notice register an organization address with the hub and join the trust graph\n    /// @dev signup is permanent for organizations too, there\'s no way to unsignup\n    function organizationSignup() public {\n        // can\'t register as an organization if you have a token\n        require(address(userToToken[msg.sender]) == address(0), "Normal users cannot signup as organizations");\n        // can\'t register as an organization twice\n        require(organizations[msg.sender] == false, "You can\'t sign up as an organization twice");\n\n        organizations[msg.sender] = true;\n\n        emit OrganizationSignup(msg.sender);\n    }\n\n    /// @notice trust a user, calling this means you\'re able to receive tokens from this user transitively\n    /// @dev the trust graph is weighted and directed\n    /// @param user the user to be trusted\n    /// @param limit the amount this user is trusted, as a percentage of 100\n    function trust(address user, uint limit) public {\n        // only users who have signed up as tokens or organizations can enter the trust graph\n        require(address(userToToken[msg.sender]) != address(0) || organizations[msg.sender], "You can only trust people after you\'ve signed up!");\n        // you must continue to trust yourself 100%\n        require(msg.sender != user, "You can\'t untrust yourself");\n        // organizations can\'t receive trust since they don\'t have their own token (ie. there\'s nothing to trust)\n        require(organizations[user] == false, "You can\'t trust an organization");\n        // must a percentage\n        require(limit <= 100, "Limit must be a percentage out of 100");\n        // organizations don\'t have a token to base send limits off of, so they can only trust at rates 0 or 100\n        if (organizations[msg.sender]) {\n            require(limit == 0 || limit == 100, "Trust is binary for organizations");\n        }\n        _trust(user, limit);\n    }\n\n    /// @dev used internally in both the trust function and signup\n    /// @param user the user to be trusted\n    /// @param limit the amount this user is trusted, as a percentage of 100\n    function _trust(address user, uint limit) internal {\n        limits[msg.sender][user] = limit;\n        emit Trust(msg.sender, user, limit);\n    }\n\n    /// @dev this is an implementation of exponentiation by squares\n    /// @param base the base to be used in the calculation\n    /// @param exponent the exponent to be used in the calculation\n    /// @return the result of the calculation\n    function pow(uint256 base, uint256 exponent) public pure returns (uint256) {\n        if (base == 0) {\n            return 0;\n        }\n        if (exponent == 0) {\n            return 1;\n        }\n        if (exponent == 1) {\n            return base;\n        }\n        uint256 y = 1;\n        while(exponent > 1) {\n            if(exponent.mod(2) == 0) {\n                base = base.mul(base);\n                exponent = exponent.div(2);\n            } else {\n                y = base.mul(y);\n                base = base.mul(base);\n                exponent = (exponent.sub(1)).div(2);\n            }\n        }\n        return base.mul(y);\n    }\n\n    /// @notice finds the maximum amount of a specific token that can be sent between two users\n    /// @dev the goal of this function is to always return a sensible number, it\'s used to validate transfer throughs, and also heavily in the graph/pathfinding services\n    /// @param tokenOwner the safe/owner that the token was minted to\n    /// @param src the sender of the tokens\n    /// @param dest the recipient of the tokens\n    /// @return the amount of tokenowner\'s token src can send to dest\n    function checkSendLimit(address tokenOwner, address src, address dest) public view returns (uint256) {\n\n        // there is no trust\n        if (limits[dest][tokenOwner] == 0) {\n            return 0;\n        }\n\n        // if dest hasn\'t signed up, they cannot trust anyone\n        if (address(userToToken[dest]) == address(0) && !organizations[dest] ) {\n            return 0;\n        }\n\n        //if the token doesn\'t exist, it can\'t be sent/accepted\n        if (address(userToToken[tokenOwner]) == address(0)) {\n             return 0;\n        }\n\n        uint256 srcBalance = userToToken[tokenOwner].balanceOf(src);\n\n        // if sending dest\'s token to dest, src can send 100% of their holdings\n        // for organizations, trust is binary - if trust is not 0, src can send 100% of their holdings\n        if (tokenOwner == dest || organizations[dest]) {\n            return srcBalance;\n        }\n\n        // find the amount dest already has of the token that\'s being sent\n        uint256 destBalance = userToToken[tokenOwner].balanceOf(dest);\n\n        uint256 oneHundred = 100;\n        \n        // find the maximum possible amount based on dest\'s trust limit for this token\n        uint256 max = (userToToken[dest].balanceOf(dest).mul(limits[dest][tokenOwner])).div(oneHundred);\n        \n        // if trustLimit has already been overriden by a direct transfer, nothing more can be sent\n        if (max < destBalance) return 0;\n\n        uint256 destBalanceScaled = destBalance.mul(oneHundred.sub(limits[dest][tokenOwner])).div(oneHundred);\n        \n        // return the max amount dest is willing to hold minus the amount they already have\n        return max.sub(destBalanceScaled);\n    }\n\n    /// @dev builds the validation data structures, called for each transaction step of a transtive transactions\n    /// @param src the sender of a single transaction step\n    /// @param dest the recipient of a single transaction step\n    /// @param wad the amount being passed along a single transaction step\n    function buildValidationData(address src, address dest, uint wad) internal {\n        // the validation mapping has this format\n        // { address: {\n        //     seen: whether this user is part of the transaction,\n        //     sent: total amount sent by this user,\n        //     received: total amount received by this user,\n        //    }\n        // }\n        if (validation[src].seen != false) {\n            // if we have seen the addresses, increment their sent amounts\n            validation[src].sent = validation[src].sent.add(wad);\n        } else {\n            // if we haven\'t, add them to the validation mapping\n            validation[src].seen = true;\n            validation[src].sent = wad;\n            seen.push(src);\n        }\n        if (validation[dest].seen != false) {\n            // if we have seen the addresses, increment their sent amounts\n            validation[dest].received = validation[dest].received.add(wad);\n        } else {\n            // if we haven\'t, add them to the validation mapping\n            validation[dest].seen = true;\n            validation[dest].received = wad; \n            seen.push(dest);   \n        }\n    }\n\n    /// @dev performs the validation for an attempted transitive transfer\n    /// @param steps the number of steps in the transitive transaction\n    function validateTransferThrough(uint256 steps) internal {\n        // a valid path has only one real sender and receiver\n        address src;\n        address dest;\n        // iterate through the array of all the addresses that were part of the transaction data\n        for (uint i = 0; i < seen.length; i++) {\n            transferValidator memory curr = validation[seen[i]];\n            // if the address sent more than they received, they are the sender\n            if (curr.sent > curr.received) {\n                // if we\'ve already found a sender, transaction is invalid\n                require(src == address(0), "Path sends from more than one src");\n                // the real token sender must also be the transaction sender\n                require(seen[i] == msg.sender, "Path doesn\'t send from transaction sender");\n                src = seen[i];\n            }\n            // if the address received more than they sent, they are the recipient\n            if (curr.received > curr.sent) {\n                // if we\'ve already found a recipient, transaction is invalid\n                require(dest == address(0), "Path sends to more than one dest");\n                dest = seen[i];\n            }\n        }\n        // a valid path has both a sender and a recipient\n        require(src != address(0), "Transaction must have a src");\n        require(dest != address(0), "Transaction must have a dest");\n        // sender should not recieve, recipient should not send\n        // by this point in the code, we should have one src and one dest and no one else\'s balance should change\n        require(validation[src].received == 0, "Sender is receiving");\n        require(validation[dest].sent == 0, "Recipient is sending");\n        // the total amounts sent and received by sender and recipient should match\n        require(validation[src].sent == validation[dest].received, "Unequal sent and received amounts");\n        // the maximum amount of addresses we should see is one more than steps in the path\n        require(seen.length <= steps + 1, "Seen too many addresses");\n        emit HubTransfer(src, dest, validation[src].sent);\n        // clean up the validation datastructures\n        for (uint i = seen.length; i >= 1; i--) {\n            delete validation[seen[i-1]];\n        }\n        delete seen;\n        // sanity check that we cleaned everything up correctly\n        require(seen.length == 0, "Seen should be empty");\n    }\n\n    /// @notice walks through tokenOwners, srcs, dests, and amounts array and executes transtive transfer\n    /// @dev tokenOwners[0], srcs[0], dests[0], and wads[0] constitute a transaction step\n    /// @param tokenOwners the owner of the tokens being sent in each transaction step\n    /// @param srcs the sender of each transaction step\n    /// @param dests the recipient of each transaction step\n    /// @param wads the amount for each transaction step\n    function transferThrough(\n        address[] memory tokenOwners,\n        address[] memory srcs,\n        address[] memory dests,\n        uint[] memory wads\n    ) public {\n        // all the arrays must be the same length\n        require(dests.length == tokenOwners.length, "Tokens array length must equal dests array");\n        require(srcs.length == tokenOwners.length, "Tokens array length must equal srcs array");\n        require(wads.length == tokenOwners.length, "Tokens array length must equal amounts array");\n        for (uint i = 0; i < srcs.length; i++) {\n            address src = srcs[i];\n            address dest = dests[i];\n            address token = tokenOwners[i];\n            uint256 wad = wads[i];\n            \n            // check that no trust limits are violated\n            uint256 max = checkSendLimit(token, src, dest);\n            require(wad <= max, "Trust limit exceeded");\n\n            buildValidationData(src, dest, wad);\n            \n            // go ahead and do the transfers now so that we don\'t have to walk through this array again\n            userToToken[token].hubTransfer(src, dest, wad);\n        }\n        // this will revert if there are any problems found\n        validateTransferThrough(srcs.length);\n    }\n}\n')))))}c.isMDXComponent=!0}}]);