<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Circles UBI | Handbook Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Circles UBI | Handbook Blog Atom Feed"><title data-react-helmet="true">Technical Overview for Circles Garden | Circles UBI | Handbook</title><meta data-react-helmet="true" property="og:url" content="https://handbook.joincircles.net/docs/developers/architecture/tech-overview"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Technical Overview for Circles Garden | Circles UBI | Handbook"><meta data-react-helmet="true" name="description" content="Author: Jacqueline Monta  | 2022"><meta data-react-helmet="true" property="og:description" content="Author: Jacqueline Monta  | 2022"><link data-react-helmet="true" rel="shortcut icon" href="/images/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://handbook.joincircles.net/docs/developers/architecture/tech-overview"><link data-react-helmet="true" rel="alternate" href="https://handbook.joincircles.net/docs/developers/architecture/tech-overview" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://handbook.joincircles.net/docs/developers/architecture/tech-overview" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.12b1e604.css">
<link rel="preload" href="/assets/js/runtime~main.4562d9fe.js" as="script">
<link rel="preload" href="/assets/js/main.bce00700.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/images/logo.svg" alt="Circles UBI" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/images/logo.svg" alt="Circles UBI" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Circles Handbook</strong></a><a class="navbar__item navbar__link" href="/docs/users">Users</a><a class="navbar__item navbar__link" href="/docs/communities">Communities</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/developers">Developers</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/developers/whitepaper">Whitepaper</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/images/logo.svg" alt="Circles UBI" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/images/logo.svg" alt="Circles UBI" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Circles Handbook</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/users">Users</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/communities">Communities</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/developers">Developers</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/developers/whitepaper">Whitepaper</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/developers">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/developers/whitepaper">Whitepaper</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">System Architecture</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/developers/architecture/tech-overview">Technical Overview for Circles Garden</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">API Reference</a><ul class="menu__list"><li class="menu__list-item"><a href="https://circlesubi.github.io/circles-core" target="_blank" rel="noopener noreferrer" class="menu__link menuLinkExternal_1OhN" tabindex="-1">circles-core</a></li><li class="menu__list-item"><a href="https://github.com/CirclesUBI/circles-api/blob/main/API.md" target="_blank" rel="noopener noreferrer" class="menu__link menuLinkExternal_1OhN" tabindex="-1">circles-api</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Transitive transactions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/developers/transitive-transactions/transfer-limitations-in-practice">The limitation of transitive transactions in practice</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/developers/tutorials/circles-by-hand-with-sbt-ethereum">Circles by hand with sbt-ethereum</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/developers/tutorials/estimate-gas-cost">Exploring transfer steps and estimating the gas cost</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/developers/tutorials/gnosis-safe-as-wallet">Gnosis Safe as Wallet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/developers/tutorials/mint-crc-no-relay-service">Mint CRC without Relay Service</a></li></ul></li><li class="menu__list-item"><a href="https://joincircles.net/faq" target="_blank" rel="noopener noreferrer" class="menu__link menuLinkExternal_1OhN">FAQ</a></li><li class="menu__list-item"><a href="https://github.com/CirclesUBI/.github/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="menu__link menuLinkExternal_1OhN">Contributing</a></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Technical Overview for Circles Garden</h1></header><div class="markdown"><p><em>Author: Jacqueline Monta  | 2022</em></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="system-description"></a>System Description<a class="hash-link" href="#system-description" title="Direct link to heading">#</a></h2><p>The system can be decomposed into two layers:
<strong>Layer 0</strong> --&gt; Blockchain layer
<strong>Layer 1</strong>  --&gt; Circles Garden Services Layer</p><img alt="Architecture layers" src="/6a04f63ca71ebaf05265487367401677.jpg" style="width:90%;height:90%;padding:1.2rem;display:block;margin-left:auto;margin-right:auto"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="layer-0---blockchain-layer"></a>Layer 0 - Blockchain layer<a class="hash-link" href="#layer-0---blockchain-layer" title="Direct link to heading">#</a></h2><p>To understand Circles infrastructure, it is necesssary to understand the Blockchain infrastructure first. </p><p><strong>Blockchain</strong></p><ul><li>Every block has a list of transactions.</li><li>There is a limitation of how many transactions can be processed per time or per block.</li><li>Transactions wait in the memory pool before being added into a block:</li></ul><img alt="Memory pool and transactions" src="/88162ffa16b526214ef5f5c32923185e.png" style="width:80%;height:80%;padding:1.2rem;display:block;margin-left:auto;margin-right:auto"><p>Source: <a href="https://www.semanticscholar.org/paper/Contra-*%3A-Mechanisms-for-Countering-Spam-Attacks-on-Saad-Kim/0dd0a39b30fe4ad5fc637ba4f571623ed385b752" target="_blank" rel="noopener noreferrer">Semanthics scholars</a></p><p><strong>Ethereum</strong></p><ul><li><a href="https://ethereum.org/en/developers/docs/" target="_blank" rel="noopener noreferrer">Descentralised blockchain platform</a>.</li><li>An <a href="https://ethereum.org/en/developers/docs/nodes-and-clients/" target="_blank" rel="noopener noreferrer">Ethereum Client</a> is a node of the network. There are different <a href="https://ethereum.org/en/developers/docs/nodes-and-clients/" target="_blank" rel="noopener noreferrer">node types</a> and node implementations (we use Nethermind).</li><li><a href="https://www.quicknode.com/guides/infrastructure/ethereum-full-node-vs-archive-node" target="_blank" rel="noopener noreferrer">Ethereum full node vs archive node</a>: Full nodes are the nodes that copy and verify transactions on the blockchain and help maintain the blockchain state. They store the state of the most recent 128 blocks. Archive nodes are full nodes running with a special option known as &quot;archive mode&quot;. Archive nodes have all the historical data of the blockchain since the genesis block.</li><li>Running your own node can be difficult and you donâ€™t always need to run your own instance. In this case, you can use a third party API provider like <a href="https://getblock.io/" target="_blank" rel="noopener noreferrer">GetBlock</a> or <a href="https://www.quicknode.com/" target="_blank" rel="noopener noreferrer">QuickNode</a>.</li><li>Every Ethereum client implements an <a href="https://ethereum.org/en/developers/docs/apis/json-rpc/" target="_blank" rel="noopener noreferrer">JSON-RPC API</a>.</li><li>Ethereum protocol uses an <a href="https://www.oreilly.com/library/view/mastering-ethereum/9781491971932/ch04.html" target="_blank" rel="noopener noreferrer">eliptic curve algorithm</a>.</li><li><a href="https://takenobu-hs.github.io/downloads/ethereum_evm_illustrated.pdf" target="_blank" rel="noopener noreferrer">Ethereum Virtual Machine (EVM)</a> is a sandboxed virtual stack embedded within each full Ethereum node, responsible for executing contract bytecode.<ul><li>Transactions require time and money. Every write transaction needs to be paid by <a href="https://ethereum.org/en/developers/docs/gas/#what-is-gas" target="_blank" rel="noopener noreferrer">gas fees</a>.</li><li>Storage in the EVM also requires a fee.</li><li>The cost of an operation is not fixed. There are methods for gas estimation. </li><li>It is possible to reduce the gas price. This translates in longer waiting times for the transaction to get processed.</li></ul></li><li>Ethereum introduces the idea of:<ul><li>Token: a simple transaction specifies <code>{from, to, value, token}</code></li><li>Smart Contracts</li></ul></li><li>When multiple nodes are processing a transaction, they need to reach an agreement using a <a href="https://ethereum.org/en/developers/docs/consensus-mechanisms/" target="_blank" rel="noopener noreferrer">consensus mechanism</a>.</li><li><a href="https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/" target="_blank" rel="noopener noreferrer">Proof of Stake (PoS)</a> is the consensus mechanism of Gnosis Chain and Ethereum.</li></ul><p><strong>Smart Contracts in Ethereum</strong></p><p><a href="https://ethereum.org/en/smart-contracts/" target="_blank" rel="noopener noreferrer">Smart contracts</a> are the fundamental building blocks of Ethereum applications. They are computer programs stored on the blockchain. A &quot;smart contract&quot; is a collection of code (its functions) and data (its state) that resides at a specific address on the Ethereum blockchain.</p><p>Smart contracts are a type of <a href="https://ethereum.org/en/developers/docs/accounts/" target="_blank" rel="noopener noreferrer">Ethereum account</a>. This means they have a balance and they can send transactions over the network. However they&#x27;re not controlled by a user, instead they are deployed to the network and run as programmed. User accounts can then interact with a smart contract by submitting transactions that execute a function defined on the smart contract. Smart contracts can define rules, like a regular contract, and automatically enforce them via the code. Smart contracts cannot be deleted by default, and interactions with them are irreversible.</p><p>Ethereum has developer-friendly languages for writing smart contracts such as <a href="https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html" target="_blank" rel="noopener noreferrer">Solidity</a>. Then the code is translated as a chain of commands on an EVM.</p><p><strong>Circles Protocol</strong></p><p>The Circles protocol is a set of smart contracts that are currently deployed on the <a href="https://www.gnosis.io/" target="_blank" rel="noopener noreferrer">Gnosis Chain</a>, which is a stable payments EVM (Ethereum Virtual Machine) blockchain.</p><p>Development on Gnosis Chain (GC) is easy and intuitive for Ethereum developers. Since GC is an EVM chain, smart contracts can be written and deployed in exactly the same way simply by setting a <a href="https://docs.gnosischain.com/tools/rpc" target="_blank" rel="noopener noreferrer">different RPC endpoint</a>.</p><img alt="Blockchain-Circles world" src="/69da4aaed9927db6811b1a6927eccaeb.png" style="width:80%;height:80%;padding:1.2rem;display:block;margin-left:auto;margin-right:auto"><p>Read the <a href="https://handbook.joincircles.net/docs/developers/whitepaper/" target="_blank" rel="noopener noreferrer">white paper</a> for context, where the Circles protocol is abstracted. Actually, the Circles protocol could be implemented in any other platform (not in Ethereum, which is a really slow and inefficient db).</p><p>The main <a href="https://github.com/CirclesUBI/circles-contracts" target="_blank" rel="noopener noreferrer">Circles smart contracts</a> are:</p><ul><li><p><strong><a href="https://github.com/CirclesUBI/circles-contracts/blob/master/contracts/Hub.sol" target="_blank" rel="noopener noreferrer">Hub Smart Contract</a></strong></p><ul><li>It is a key-value storage that stores information about trust conections, token ownership, and all information required for the system to work.</li><li>It validates transfers, maintains the trust network.</li><li>Stores whether users are organizations.</li><li>Important methods:<ul><li><strong>Sign up:</strong> adds a user to the trust network and creates a circles token for that user.</li><li><strong>Transfer:</strong> it applies the restrictions of the trust network in order to execute a transaction. In the blockchain, any token can be sent at any account at any time, however, the hubTransfer is what makes a difference to give real value to CRC inside the trust network.</li><li><strong>Trust:</strong> provides trust from a user to another.</li></ul></li><li>Any ethereum address can sign up in the Hub (smart contracts, EOA...) and participate in the trust network.</li><li>Subscription to the Hub through sockets.</li><li>There is only <a href="https://blockscout.com/xdai/mainnet/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543/read-contract" target="_blank" rel="noopener noreferrer">one hub</a> currently deployed on GC. </li><li>As it is, the hub works, in case a new hub is implemented it will be necessary to migrate all users from one hub to another. </li></ul></li><li><p><strong><a href="https://github.com/CirclesUBI/circles-contracts/blob/master/contracts/Token.sol" target="_blank" rel="noopener noreferrer">Token Smart Contract</a></strong></p><ul><li>Its implementation is inherited from the <a href="https://eips.ethereum.org/EIPS/eip-20" target="_blank" rel="noopener noreferrer">ERC20 token standard implementation</a>.</li><li>It is a hashmap <code>addr&lt;&gt;amount</code>.</li><li>It stores information about who owns which token (balance).</li><li>It is in charge of minting (which is represents the UBI issuance), through the public method <code>update()</code>.</li><li>It implements a liveliness triger to stop minting if the <code>update()</code> method hasn&#x27;t been called for 90 days.</li><li>The minting can also be stopped manually by the owner of the token.</li></ul></li><li><p><strong><a href="https://github.com/CirclesUBI/safe-contracts" target="_blank" rel="noopener noreferrer">Safe Smart Contract</a></strong></p><ul><li>Circles protocol uses <a href="https://docs.gnosis-safe.io/" target="_blank" rel="noopener noreferrer">Gnosis Safe</a> smart contracts to provide resilience and security using its multisignature feature.</li><li>A <a href="https://help.gnosis-safe.io/en/articles/3876456-what-is-gnosis-safe" target="_blank" rel="noopener noreferrer">Safe</a> represents a Circles account (also called Circles profile). One smart contract is deployed per user.</li><li>In UBI accounts, the Safe is the owner of the Token.</li><li>The Safe has owners itself (only one by default), which are the device addresses.</li><li>The owner of the Safe (the keypair/ethereum account) manages the Safe, and can sign transactions on behalf of the Safe.</li><li>Organizations (also called Shared Wallets) are also Safes, without a token, and with many owners.</li><li>The Safe used in Circles is a clone of the Master copy. The version is explicitly set in the application.</li><li>Currently circles.garden uses the Safe <code>v1.3.0+L2</code>.</li></ul></li><li><p><strong><a href="https://github.com/gnosis/safe-contracts/blob/main/contracts/proxies/GnosisSafeProxyFactory.sol" target="_blank" rel="noopener noreferrer">Gnosis Proxy Factory</a> and Gnosis Master Safe</strong></p><ul><li>Deploying a GnosisSafe smart contract in the blockchain is expensive.</li><li>Therefore, the Proxy Factory and the Master Copy are used for reducing the cost of the deployment of a new Safe.</li><li>Every deployment using GnosisSafe is done through the Proxy Factory, which is deployed once per blockchain. Only unique parts of the Safe smart contracts are deployed, making less expensive to deploy a new Safe.</li><li>There&#x27;s one deployment per version. For example:<ul><li>1.1.1 -&gt; the one Circles-Garden used before</li><li>1.3.0 -&gt; the one Circles-Garden uses now</li></ul></li></ul></li></ul><p>There are also Ethereum events from the smart contracts, so our services can listen to blockchain events.</p><p>There&#x27;s a new upgrade path, which will have to be verified by the community. Read <a href="https://aboutcircles.com/t/earth-circle-ip-1-circles-2-0-contracts/428" target="_blank" rel="noopener noreferrer">the Circles 2.0 proposal</a> in the forum for more information.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="layer-1---circles-garden-services-layer"></a>Layer 1 - Circles Garden Services Layer<a class="hash-link" href="#layer-1---circles-garden-services-layer" title="Direct link to heading">#</a></h2><p>Up to now, the blockchain and the smart contract world is the common environment where different Circles apps (or wallets) and services live on top of, such as <strong>circles.garden</strong>, <strong>circles.pink</strong>, or <strong><a href="https://staging.circlesubi.id/#/" target="_blank" rel="noopener noreferrer">https://staging.circlesubi.id/#/</a></strong>.</p><p>The Circles Garden system architecture has multiple intermediate services to interact with the Blockchain world to overcome different limitations:</p><ul><li>Relayer</li><li>graph-node</li><li>Api</li><li>Pathfinder</li><li>Trust and Capacity Networks</li></ul><p>Let&#x27;s describe each one of the services by explaining the limitations they are solving, and how they are implemented.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="relayer"></a><a href="https://github.com/CirclesUBI/safe-relay-service" target="_blank" rel="noopener noreferrer">Relayer</a><a class="hash-link" href="#relayer" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="purpose"></a>Purpose<a class="hash-link" href="#purpose" title="Direct link to heading">#</a></h4><p>Every transaction in Ethereum carries some fees. The payment can be done with a token through an account that can be verified.</p><p>In the Ethereum mainnet these transactions are costly, that&#x27;s the reason why Circles uses Gnosis side chain.</p><p>The relayer main purpose is to make transaction fees payment transparent for the user.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="solution"></a>Solution<a class="hash-link" href="#solution" title="Direct link to heading">#</a></h4><p>The Relayer pays for the transaction fees on behalf of the user through meta-transactions (see ERC20 specification) to the Gnosis Chain. It pays for the Safe deployment and the gas fees for all the users of circles.garden. Therefore, the relayer can be used for controlling expenses since writing in the blockchain is always done through this service. </p><p>Also, as it deploys the Safe for the users, it takes care of which version of Safe contract is used.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="implementation"></a>Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">#</a></h4><p>It is a django webapp, already developed by Gnosis. The Garden uses a fork of their implementation of the relayer, adding some patches by Bitspossessed. Currently the project is not maintained by Gnosis, they deprecated it.</p><p>It uses <a href="https://docs.celeryproject.org/en/stable/getting-started/introduction.html" target="_blank" rel="noopener noreferrer">Celery framework</a> for task management and queues.</p><p>You can check the API documentation in the local env: <a href="http://relay.circles.local/" target="_blank" rel="noopener noreferrer">http://relay.circles.local/</a></p><p>The Gnosis API also can be checked here <a href="https://safe-transaction.gnosis.io/" target="_blank" rel="noopener noreferrer">https://safe-transaction.gnosis.io/</a></p><p>There are 2 keys for the two functions: </p><ul><li>the funder, for paying Safe deployments</li><li>the sender, for paying other transactions</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bottlenecks"></a>Bottlenecks<a class="hash-link" href="#bottlenecks" title="Direct link to heading">#</a></h4><p>The main bottleneck is scalabitily. There is only one relayer, which means, this service is in charge of all the transactions for every user of circles.garden. If there is a large number of transactions asking for payment, these get added to the queue, and worsening the user experience because these translates in longer waiting times (delays).</p><p>The relayer takes care of some other tasks, that could be moved to a different service in order to mitigate the delays and improve simplification, such as: </p><ul><li>create and pay for the Safe</li><li>keep track of the nonce</li><li>scans the gas price</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="missing-features"></a>Missing features<a class="hash-link" href="#missing-features" title="Direct link to heading">#</a></h4><ul><li>Recovery mode to react to reorgs. Sometimes the relayer gets stuck because a transaction is registered in the DB but actually didn&#x27;t happen in the blockchain and the nonce gets out of sync. The relayer was created for mainnet, not for Gnosis Chain, where forks happen more often</li><li>Restart mechanism</li><li>Failure tracing: errors are not propagated to the DApp</li><li>Paralellelization: Having different relayers (different keys), sharing a db or making them not needing the db too much</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="the-graph"></a><a href="https://github.com/graphprotocol/graph-node" target="_blank" rel="noopener noreferrer">The Graph</a><a class="hash-link" href="#the-graph" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="purpose-1"></a>Purpose<a class="hash-link" href="#purpose-1" title="Direct link to heading">#</a></h4><p>The data stored in the EVM storage is not in the shape you need for computing it. It&#x27;s really limited (there&#x27;s not even Arrays). Thus  The Graph exists to index the Circles data from the blockchain.</p><p>These are the most important limitations addressed:</p><ul><li><p><strong>Token indexing</strong>: The Token Smart Contract holds the information about the amount of tokens an address has. So in order to get the total balance of an specific user it would be necessary to query all the circles tokens signed up in the Hub. This process would be quite costly. The subgraph stores the balances on the Safe entity to allow getting the balance of an user.</p></li><li><p><strong>Trust indexing</strong>: The Hub Smart Contract contains a mapping of the trust limits from one user to another. To build the trust network it would be necessary to go through every mapping in the hub and build the network. When a new account is created there is another node to be added to the network. This process is quite costly both economically and computationally.</p></li><li><p><strong>Safe indexing</strong>: We can easily get the owners of a given Safe, but not the opposite. The subgraph stores the Safes of a given owner.</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="solution-1"></a>Solution<a class="hash-link" href="#solution-1" title="Direct link to heading">#</a></h4><p><a href="https://thegraph.com/en/" target="_blank" rel="noopener noreferrer">The Graph</a> listens to blockchain events. In each block there&#x27;s a list of Events, and the graph uses this list to find the interesting transactions (txs), and index the useful information based on a predefined schema. It implements a materialization: it&#x27;s a view of the blockchain data. Learn more in the <a href="https://thegraph.com/docs/en/about/introduction/" target="_blank" rel="noopener noreferrer">official documentation</a>.</p><p>The <a href="https://github.com/graphprotocol/graph-node" target="_blank" rel="noopener noreferrer"><code>graph-node</code> service</a> allows indexing from a specific block, and it has many other interesting features.</p><p>Circles.Garden uses the graph as a database for:</p><ul><li>trust connections</li><li>balances</li><li>safes owned</li><li>notifications</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="implementation-1"></a>Implementation<a class="hash-link" href="#implementation-1" title="Direct link to heading">#</a></h4><p>There is a <a href="https://github.com/CirclesUBI/circles-subgraph" target="_blank" rel="noopener noreferrer">subgraph</a> deployed for Circles data. It has functions to process the <strong>Events</strong> that are of interest. It includes also data types and entity definitions. </p><p>That information retrieved from the events is structured in a way that is useful and easy to process. Then it is stored in a database (Postgres), and with graphql one is able to query the information on demand. The queries are fast because the indexing was previously done.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bottlenecks-1"></a>Bottlenecks<a class="hash-link" href="#bottlenecks-1" title="Direct link to heading">#</a></h4><p>We are currently using a subgraph deployed in our <a href="https://github.com/CirclesUBI/circles-iac/tree/main/ansible/roles/graph-protocol" target="_blank" rel="noopener noreferrer">self-hosted service</a> and keep backup in the <a href="https://thegraph.com/hosted-service/subgraph/circlesubi/circles-ubi" target="_blank" rel="noopener noreferrer">free Hosted Service of The Graph</a>. The Hosted Service is a centralised service run by Edge &amp; Node, one of the core developer teams at The Graph. It is free to both deploy and query subgraphs on the Hosted Service.</p><p>Synchronisation is often lost between the subgraph and the blockchain. This can be seen in the <a href="https://dashboard.circles.garden/" target="_blank" rel="noopener noreferrer">dashboard</a>. The effect in the webapp is that the data comes with an undessirable delay.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="api"></a><a href="https://github.com/CirclesUBI/circles-api" target="_blank" rel="noopener noreferrer">API</a><a class="hash-link" href="#api" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="purpose-2"></a>Purpose<a class="hash-link" href="#purpose-2" title="Direct link to heading">#</a></h4><p>The API Solves 2 problems:</p><ol><li>User data storage<ul><li>Storage on-chain is expensive. Thus the api saves the off-chain data and makes it accessible for circles.garden. </li><li>Storing sensitive information on-chain such us username or payment description is not desired. </li><li>Profile pictures for example are saved in AWS at the moment.</li></ul></li><li>Transitive transfer service (see next section &quot;Pathfinder / transfer service&quot;)</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="solution-2"></a>Solution<a class="hash-link" href="#solution-2" title="Direct link to heading">#</a></h4><p>The API takes responsibility of storing off-chain data in its database (postgres) and AWS.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="implementation-2"></a>Implementation<a class="hash-link" href="#implementation-2" title="Direct link to heading">#</a></h4><p>There&#x27;s an authentication mechanism for some of queries to the API. Payment descriptions can only be requested by accounts involved in the transaction, for example.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="missing-featuresimprovements"></a>Missing features/Improvements<a class="hash-link" href="#missing-featuresimprovements" title="Direct link to heading">#</a></h4><ul><li>Add encryption layer around the username storage</li><li>Use <a href="https://ipfs.io/" target="_blank" rel="noopener noreferrer">IPFS</a> for storage instead of AWS</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pathfinder--transfer-service"></a>Pathfinder / transfer service<a class="hash-link" href="#pathfinder--transfer-service" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="purpose-3"></a>Purpose<a class="hash-link" href="#purpose-3" title="Direct link to heading">#</a></h4><p>The Hub transfer() method does not provide a transitive transaction path between users.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="solution-3"></a>Solution<a class="hash-link" href="#solution-3" title="Direct link to heading">#</a></h4><p>Circles.garden uses a version of a pathfinder <a href="https://github.com/chriseth/pathfinder2" target="_blank" rel="noopener noreferrer">implemented by Chriseth</a>. This pathfinder uses a maxflow algorithm to come up with a path for the transitive transfers. It traverses possible paths from source to destination and returns the transfer steps of the calculated path.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="implementation-3"></a>Implementation<a class="hash-link" href="#implementation-3" title="Direct link to heading">#</a></h4><p>The API worker maintains a capacity network in its database by subscribing to blockchain events (Trust, Transfer). The API worker handles the events in different queues.</p><p>The pathfinder uses the capacity network data to calculate the maxflow path, and then returns the <a href="https://chriseth.github.io/pathfinder/" target="_blank" rel="noopener noreferrer">transfer steps</a> necessary to make a transitive transaction from A to B.</p><p>There&#x27;s a limit in the maximum amount of steps that are allowed for one transfer in the circles.garden webapp. The more steps, the more tx fees have to be paid. Also, we want all the transactions in a transitive transaction to end up in the same block on the blockchain and a block is limited in size. This limits the number of steps that a transaction can have and thus the amount. Read <a href="https://handbook.joincircles.net/docs/developers/transitive-transactions/transfer-limitations-in-practice/" target="_blank" rel="noopener noreferrer">here</a> an in depth analysis on this matter.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bottlenecks-2"></a>Bottlenecks<a class="hash-link" href="#bottlenecks-2" title="Direct link to heading">#</a></h4><p>The steps are currently calculated with the maxFlow algorithm, which gives a complete solution of the problem and the complexity grows with the infinite growth of the trust network. Other algorithms can be used, such as <a href="https://en.wikipedia.org/wiki/A*_search_algorithm" target="_blank" rel="noopener noreferrer">A*</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="trust-and-capacity-networks"></a>Trust and Capacity Networks<a class="hash-link" href="#trust-and-capacity-networks" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="trust-network"></a>Trust network<a class="hash-link" href="#trust-network" title="Direct link to heading">#</a></h4><p>It holds information regarding trust connections and trust limits.
The trust network can be obtained easily querying the Circles subgraph, but with a few blocks of delay because the graph has to process and index the Events found in the blocks.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="capacity-network"></a>Capacity network<a class="hash-link" href="#capacity-network" title="Direct link to heading">#</a></h4><p>It holds information regarding how much a user can send to another user of each token. </p><p>Capacity/trust network diagram:</p><img alt="Architecture for capacity and trust network" src="/657a229e2ecd0fd032011d31fecaab6e.png" style="width:80%;height:80%;padding:1.2rem;display:block;margin-left:auto;margin-right:auto"><p>To build the capacity network, the trust network is required because querying the blockchain is too expensive. The API worker keeps the edges of the capacity network up to date.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="syncing-data-challenge"></a>Syncing data challenge<a class="hash-link" href="#syncing-data-challenge" title="Direct link to heading">#</a></h4><p>The blockchain is the ultimate source of truth. In every block there is a potential change of the trust network. But in the blockchain the data is not structured.</p><p>The indexing tasks done by the graph and the api-worker take time, therefore the status will be always relatively old (the blockchain keeps adding blocks).</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/CirclesUBI/circles-handbook/edit/main/docs/developers/architecture/tech-overview.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/developers/whitepaper"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Whitepaper</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/developers/transitive-transactions/transfer-limitations-in-practice"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">The limitation of transitive transactions in practice Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#system-description" class="table-of-contents__link">System Description</a></li><li><a href="#layer-0---blockchain-layer" class="table-of-contents__link">Layer 0 - Blockchain layer</a></li><li><a href="#layer-1---circles-garden-services-layer" class="table-of-contents__link">Layer 1 - Circles Garden Services Layer</a><ul><li><a href="#relayer" class="table-of-contents__link">Relayer</a></li><li><a href="#the-graph" class="table-of-contents__link">The Graph</a></li><li><a href="#api" class="table-of-contents__link">API</a></li><li><a href="#pathfinder--transfer-service" class="table-of-contents__link">Pathfinder / transfer service</a></li><li><a href="#trust-and-capacity-networks" class="table-of-contents__link">Trust and Capacity Networks</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Handbook</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/users">Users</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/communities">Communities</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/developers">Developers</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/developers/whitepaper">Whitepaper</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://chat.joincircles.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chat</a></li><li class="footer__item"><a href="https://aboutcircles.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum</a></li><li class="footer__item"><a href="https://twitter.com/CirclesUBI" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://github.com/CirclesUBI" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Links</h4><ul class="footer__items"><li class="footer__item"><a href="https://joincircles.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website</a></li><li class="footer__item"><a href="https://circles.garden" target="_blank" rel="noopener noreferrer" class="footer__link-item">Circles Wallet</a></li><li class="footer__item"><a href="https://github.com/CirclesUBI/.github/blob/main/CODE_OF_CONDUCT.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code of Conduct</a></li><li class="footer__item"><a href="https://github.com/CirclesUBI/.github/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contribute</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Creative Commons Attribution Share Alike 4.0 International</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4562d9fe.js"></script>
<script src="/assets/js/main.bce00700.js"></script>
</body>
</html>